# ĞÑ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ° Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹ Ñ ÑĞµÑÑĞ¸ÑĞ¼Ğ¸ Ğ² Construct Messenger
**Ğ’ĞµÑ€ÑĞ¸Ñ**: 1.0
**Ğ”Ğ°Ñ‚Ğ°**: 27.12.2025
**Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ**: ğŸ”´ ĞšĞ Ğ˜Ğ¢Ğ˜Ğ§Ğ•Ğ¡ĞšĞ˜Ğ™ - Ñ‚Ñ€ĞµĞ±ÑƒĞµÑ‚ÑÑ ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ñ Ñ€ĞµĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸ĞµĞ¹

---

## ğŸ“‹ ĞĞ³Ğ»Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ
1. [ĞĞ±Ñ‰Ğ¸Ğ¹ Ğ¿Ñ€Ğ¸Ğ½Ñ†Ğ¸Ğ¿](#Ğ¾Ğ±Ñ‰Ğ¸Ğ¹-Ğ¿Ñ€Ğ¸Ğ½Ñ†Ğ¸Ğ¿)
2. [Ğ Ğ¾Ğ»Ğ¸ ÑƒÑ‡Ğ°ÑÑ‚Ğ½Ğ¸ĞºĞ¾Ğ²](#Ñ€Ğ¾Ğ»Ğ¸-ÑƒÑ‡Ğ°ÑÑ‚Ğ½Ğ¸ĞºĞ¾Ğ²)
3. [Ğ¥Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ñ ÑĞµÑÑĞ¸Ğ¹](#Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ-ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ñ-ÑĞµÑÑĞ¸Ğ¹)
4. [Ğ”ĞµÑ‚Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ flow: Alice â†’ Bob (Ğ¿ĞµÑ€Ğ²Ğ¾Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ)](#Ğ´ĞµÑ‚Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹-flow-alice--bob-Ğ¿ĞµÑ€Ğ²Ğ¾Ğµ-ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ)
5. [Ğ”ĞµÑ‚Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ flow: Bob â†’ Alice (Ğ¾Ñ‚Ğ²ĞµÑ‚)](#Ğ´ĞµÑ‚Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹-flow-bob--alice-Ğ¾Ñ‚Ğ²ĞµÑ‚)
6. [ĞŸĞ¾ÑĞ»ĞµĞ´ÑƒÑÑ‰Ğ¸Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ](#Ğ¿Ğ¾ÑĞ»ĞµĞ´ÑƒÑÑ‰Ğ¸Ğµ-ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ)
7. [Ğ¢Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ° ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğ¹](#Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ°-ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğ¹)
8. [ĞŸĞ¾Ñ‚ĞµĞ½Ñ†Ğ¸Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼Ñ‹](#Ğ¿Ğ¾Ñ‚ĞµĞ½Ñ†Ğ¸Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ-Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼Ñ‹)

---

## ĞĞ±Ñ‰Ğ¸Ğ¹ Ğ¿Ñ€Ğ¸Ğ½Ñ†Ğ¸Ğ¿

### ĞšÑ€Ğ¸Ğ¿Ñ‚Ğ¾Ğ³Ñ€Ğ°Ñ„Ğ¸Ñ‡ĞµÑĞºĞ¸Ğµ ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ñ‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    E2EE Protocol Stack                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Layer 3: Double Ratchet (session encryption)               â”‚
â”‚           â”œâ”€ Sending chain (our messages)                   â”‚
â”‚           â”œâ”€ Receiving chain (their messages)               â”‚
â”‚           â””â”€ Ratchet state (forward secrecy)                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Layer 2: X3DH (session establishment)                      â”‚
â”‚           â”œâ”€ Shared secret derivation                       â”‚
â”‚           â”œâ”€ Signature verification                         â”‚
â”‚           â””â”€ Root key generation                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Layer 1: Key Material                                      â”‚
â”‚           â”œâ”€ Identity Key (long-term)                       â”‚
â”‚           â”œâ”€ Signed Prekey (rotatable)                      â”‚
â”‚           â””â”€ Signature + Verifying Key                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ ÑĞµÑÑĞ¸Ğ¸: Ğ´Ğ²Ğ° Ğ¿ÑƒÑ‚Ğ¸

**ĞšĞ Ğ˜Ğ¢Ğ˜Ğ§Ğ•Ğ¡ĞšĞ˜ Ğ’ĞĞ–ĞĞ**: Ğ¡ÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒĞµÑ‚ Ğ”Ğ’Ğ Ñ€Ğ°Ğ·Ğ½Ñ‹Ñ… ÑĞ¿Ğ¾ÑĞ¾Ğ±Ğ° Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸ Double Ratchet ÑĞµÑÑĞ¸Ğ¸:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    SESSION INITIALIZATION                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Path A: INITIATOR (Alice)                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ 1. Request Bob's PublicKeyBundle                         â”‚ â”‚
â”‚  â”‚ 2. Perform X3DH â†’ root_key                               â”‚ â”‚
â”‚  â”‚ 3. Call init_session(bob_bundle)                         â”‚ â”‚
â”‚  â”‚    â””â”€â†’ DoubleRatchet::new_x3dh_session(root_key, ...)   â”‚ â”‚
â”‚  â”‚    â””â”€â†’ Generate OUR sending DH pair                      â”‚ â”‚
â”‚  â”‚    â””â”€â†’ Perform DH with Bob's identity â†’ chains          â”‚ â”‚
â”‚  â”‚ 4. Ready to send (msgNum = 0)                            â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                â”‚
â”‚  Path B: RESPONDER (Bob)                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ 1. Receive first encrypted message from Alice            â”‚ â”‚
â”‚  â”‚ 2. Request Alice's PublicKeyBundle                       â”‚ â”‚
â”‚  â”‚ 3. Perform X3DH â†’ root_key                               â”‚ â”‚
â”‚  â”‚ 4. Call init_receiving_session(alice_bundle, first_msg) â”‚ â”‚
â”‚  â”‚    â””â”€â†’ DoubleRatchet::new_receiving_session(...)        â”‚ â”‚
â”‚  â”‚    â””â”€â†’ Use Alice's ephemeral DH from first message      â”‚ â”‚
â”‚  â”‚    â””â”€â†’ Derive receiving chain from her ephemeral key    â”‚ â”‚
â”‚  â”‚ 5. Can decrypt first message (msgNum = 0)               â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**âš ï¸ Ğ“Ğ›ĞĞ’ĞĞĞ¯ ĞĞ¨Ğ˜Ğ‘ĞšĞ**: Bob ĞĞ• Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ Ğ²Ñ‹Ğ·Ñ‹Ğ²Ğ°Ñ‚ÑŒ `init_session` - ÑÑ‚Ğ¾ Ğ¿ÑƒÑ‚ÑŒ Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ°Ñ‚Ğ¾Ñ€Ğ°!

---

## Ğ Ğ¾Ğ»Ğ¸ ÑƒÑ‡Ğ°ÑÑ‚Ğ½Ğ¸ĞºĞ¾Ğ²

### Alice (Initiator)
- **UUID**: Ğ›ĞµĞºÑĞ¸ĞºĞ¾Ğ³Ñ€Ğ°Ñ„Ğ¸Ñ‡ĞµÑĞºĞ¸ Ğ¼ĞµĞ½ÑŒÑˆĞµ (Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€, `0a...`)
- **Ğ Ğ¾Ğ»ÑŒ**: Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ¸Ñ€ÑƒĞµÑ‚ ÑĞµÑÑĞ¸Ñ Ğ¿ĞµÑ€Ğ²Ğ¾Ğ¹
- **Ğ”ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ**:
  1. Ğ—Ğ°Ğ¿Ñ€Ğ°ÑˆĞ¸Ğ²Ğ°ĞµÑ‚ `PublicKeyBundle` Bob'Ğ°
  2. Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€ÑƒĞµÑ‚ ÑĞµÑÑĞ¸Ñ: `init_session(bob_bundle)`
  3. ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµÑ‚ Ğ¿ĞµÑ€Ğ²Ğ¾Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ñ `messageNumber = 0`

### Bob (Responder)
- **UUID**: Ğ›ĞµĞºÑĞ¸ĞºĞ¾Ğ³Ñ€Ğ°Ñ„Ğ¸Ñ‡ĞµÑĞºĞ¸ Ğ±Ğ¾Ğ»ÑŒÑˆĞµ (Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€, `2a...`)
- **Ğ Ğ¾Ğ»ÑŒ**: ĞÑ‚Ğ²ĞµÑ‡Ğ°ĞµÑ‚ Ğ½Ğ° Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ
- **Ğ”ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ**:
  1. ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ Ğ¿ĞµÑ€Ğ²Ğ¾Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ¾Ñ‚ Alice
  2. Ğ—Ğ°Ğ¿Ñ€Ğ°ÑˆĞ¸Ğ²Ğ°ĞµÑ‚ `PublicKeyBundle` Alice
  3. Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€ÑƒĞµÑ‚ receiving session: `init_receiving_session(alice_bundle, first_message)`
  4. Ğ Ğ°ÑÑˆĞ¸Ñ„Ñ€Ğ¾Ğ²Ñ‹Ğ²Ğ°ĞµÑ‚ Ğ¿ĞµÑ€Ğ²Ğ¾Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ

---

## Ğ¥Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ñ ÑĞµÑÑĞ¸Ğ¹

### Rust Core (packages/core/src/crypto/client.rs)

```rust
pub struct ClientCrypto<P: CryptoProvider> {
    // Long-term keys (persistent)
    identity_key: P::KemPrivateKey,        // Master private key
    signed_prekey: P::KemPrivateKey,       // Rotatable signed prekey
    signing_key: P::SignaturePrivateKey,   // For signing prekeys

    // Runtime session storage (in-memory)
    sessions: HashMap<String, DoubleRatchetSession<P>>,
    //        ^^^^^^^ session_id â†’ active session
}
```

**âš ï¸ ĞŸĞ ĞĞ‘Ğ›Ğ•ĞœĞ #1**: Ğ¡ĞµÑÑĞ¸Ğ¸ Ñ…Ñ€Ğ°Ğ½ÑÑ‚ÑÑ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ² Ğ¿Ğ°Ğ¼ÑÑ‚Ğ¸!
- ĞŸÑ€Ğ¸ Ğ¿ĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑĞºĞµ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ Ğ²ÑĞµ ÑĞµÑÑĞ¸Ğ¸ Ñ‚ĞµÑ€ÑÑÑ‚ÑÑ
- ĞÑƒĞ¶Ğ½Ğ° ÑĞµÑ€Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ² Keychain/Core Data

### Swift Layer (ConstructMessenger/Security/CryptoManager.swift)

```swift
class CryptoManager {
    private var core: ClassicCryptoCore?  // Arc<Mutex<CryptoCore>> Ñ‡ĞµÑ€ĞµĞ· UniFFI

    // Mapping: userId â†’ sessionId (generated by Rust)
    private var userSessions: [String: String] = [:]
    //          ^^^^^^^ userId   ^^^^^^^ session_id from Rust
}
```

**âš ï¸ ĞŸĞ ĞĞ‘Ğ›Ğ•ĞœĞ #2**: ĞœĞ°Ğ¿Ğ¿Ğ¸Ğ½Ğ³ `userSessions` Ñ‚Ğ¾Ğ¶Ğµ Ğ² Ğ¿Ğ°Ğ¼ÑÑ‚Ğ¸!
- Ğ¢ĞµÑ€ÑĞµÑ‚ÑÑ Ğ¿Ñ€Ğ¸ Ğ¿ĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑĞºĞµ
- ĞĞ• ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½ Ñ Core Data

### Core Data (ConstructMessenger/Models/)

```
User
â”œâ”€â”€ id: String (UUID)
â”œâ”€â”€ username: String
â””â”€â”€ displayName: String

Chat
â”œâ”€â”€ id: String (UUID)
â”œâ”€â”€ otherUser: User
â”œâ”€â”€ lastMessageText: String?
â””â”€â”€ lastMessageTime: Date?

Message
â”œâ”€â”€ id: String (UUID)
â”œâ”€â”€ fromUserId: String
â”œâ”€â”€ toUserId: String
â”œâ”€â”€ encryptedContent: String (Base64)
â”œâ”€â”€ decryptedContent: String?
â”œâ”€â”€ timestamp: Date
â”œâ”€â”€ isSentByMe: Bool
â”œâ”€â”€ deliveryStatus: DeliveryStatus
â””â”€â”€ chat: Chat
```

**âš ï¸ ĞŸĞ ĞĞ‘Ğ›Ğ•ĞœĞ #3**: ĞĞµÑ‚ Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ğ¸ Ğ¾ ÑĞµÑÑĞ¸ÑÑ… Ğ² Core Data!
- ĞĞµÑ‚ Ğ¿Ğ¾Ğ»Ñ `Chat.sessionId`
- ĞĞµÑ‚ Ğ¿Ğ¾Ğ»Ñ `Chat.sessionState` (pending/active/expired)
- ĞĞµĞ²Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ²Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ ÑĞµÑÑĞ¸Ñ Ğ¿Ğ¾ÑĞ»Ğµ Ğ¿ĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑĞºĞ°

---

## Ğ”ĞµÑ‚Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ flow: Alice â†’ Bob (Ğ¿ĞµÑ€Ğ²Ğ¾Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ)

### Ğ¨Ğ°Ğ³ 1: Alice Ğ¾Ñ‚ĞºÑ€Ñ‹Ğ²Ğ°ĞµÑ‚ Ñ‡Ğ°Ñ‚ Ñ Bob

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ChatView(chat: bob_chat)                                    â”‚
â”‚  â”‚                                                           â”‚
â”‚  â”œâ”€â†’ ChatViewModel.init(chat: bob_chat, context: ...)      â”‚
â”‚  â”‚    â”œâ”€â†’ checkExistingSession()                            â”‚
â”‚  â”‚    â”‚    â””â”€â†’ CryptoManager.shared.hasSession(for: bob_id) â”‚
â”‚  â”‚    â”‚         â””â”€â†’ userSessions[bob_id] != nil â†’ false     â”‚
â”‚  â”‚    â”‚                                                      â”‚
â”‚  â”‚    â”œâ”€â†’ fetchRecipientPublicKey()                         â”‚
â”‚  â”‚    â”‚    â”œâ”€â†’ currentUserId = alice_id                     â”‚
â”‚  â”‚    â”‚    â”œâ”€â†’ isInitiator = (alice_id < bob_id) â†’ TRUE    â”‚
â”‚  â”‚    â”‚    â””â”€â†’ wsManager.send(.getPublicKey(bob_id))       â”‚
â”‚  â”‚    â”‚                                                      â”‚
â”‚  â”‚    â””â”€â†’ isSessionReady = false                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Ğ¡Ğ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ Ğ¿Ğ¾ÑĞ»Ğµ Step 1**:
- âœ… `isSessionReady = false` â†’ UI Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ "Initializing..."
- âœ… WebSocket Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½
- âŒ Ğ¡ĞµÑÑĞ¸Ñ ĞµÑ‰Ğµ Ğ½Ğµ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ°

### Ğ¨Ğ°Ğ³ 2: Ğ¡ĞµÑ€Ğ²ĞµÑ€ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ PublicKeyBundle Bob'Ğ°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ WebSocketManager receives:                                  â”‚
â”‚ {                                                            â”‚
â”‚   "type": "publicKeyBundle",                                â”‚
â”‚   "payload": {                                               â”‚
â”‚     "userId": "bob_id",                                      â”‚
â”‚     "username": "bob",                                       â”‚
â”‚     "identityPublic": "...",                                 â”‚
â”‚     "signedPrekeyPublic": "...",                             â”‚
â”‚     "signature": "...",                                      â”‚
â”‚     "verifyingKey": "..."                                    â”‚
â”‚   }                                                          â”‚
â”‚ }                                                            â”‚
â”‚  â”‚                                                           â”‚
â”‚  â”œâ”€â†’ ChatViewModel.handleServerMessage(.publicKeyBundle)   â”‚
â”‚  â”‚    â”œâ”€â†’ isInitiator = (alice_id < bob_id) â†’ TRUE         â”‚
â”‚  â”‚    â”‚                                                      â”‚
â”‚  â”‚    â””â”€â†’ if isInitiator {  // âœ… ALICE PATH                â”‚
â”‚  â”‚         CryptoManager.shared.initializeSession(          â”‚
â”‚  â”‚           for: bob_id,                                    â”‚
â”‚  â”‚           recipientBundle: bob_bundle                     â”‚
â”‚  â”‚         )                                                 â”‚
â”‚  â”‚         â”‚                                                 â”‚
â”‚  â”‚         â”œâ”€â†’ [Swift â†’ Rust] core.initSession(...)        â”‚
â”‚  â”‚         â”‚    â”‚                                            â”‚
â”‚  â”‚         â”‚    â”œâ”€â†’ [Rust] X3DH handshake                   â”‚
â”‚  â”‚         â”‚    â”‚    â””â”€â†’ root_key derived                   â”‚
â”‚  â”‚         â”‚    â”‚                                            â”‚
â”‚  â”‚         â”‚    â”œâ”€â†’ DoubleRatchet::new_x3dh_session(        â”‚
â”‚  â”‚         â”‚    â”‚      root_key,                             â”‚
â”‚  â”‚         â”‚    â”‚      bob_identity_public,                  â”‚
â”‚  â”‚         â”‚    â”‚      alice_identity_private                â”‚
â”‚  â”‚         â”‚    â”‚   )                                        â”‚
â”‚  â”‚         â”‚    â”‚    â”œâ”€â†’ DH(alice_priv, bob_pub) â†’ recv_ch â”‚
â”‚  â”‚         â”‚    â”‚    â”œâ”€â†’ Generate new DH pair â†’ send_pair  â”‚
â”‚  â”‚         â”‚    â”‚    â”œâ”€â†’ DH(new_priv, bob_pub) â†’ send_ch   â”‚
â”‚  â”‚         â”‚    â”‚    â””â”€â†’ Session ready!                     â”‚
â”‚  â”‚         â”‚    â”‚                                            â”‚
â”‚  â”‚         â”‚    â””â”€â†’ Returns: session_id (UUID)              â”‚
â”‚  â”‚         â”‚                                                 â”‚
â”‚  â”‚         â””â”€â†’ userSessions[bob_id] = session_id            â”‚
â”‚  â”‚                                                           â”‚
â”‚  â”‚         isSessionReady = true                             â”‚
â”‚  â”‚         processPendingMessages()                          â”‚
â”‚  â”‚       }                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Ğ¡Ğ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ Ğ¿Ğ¾ÑĞ»Ğµ Step 2**:
- âœ… Rust: `sessions[session_id]` ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ñ‚ Double Ratchet ÑĞµÑÑĞ¸Ñ
- âœ… Swift: `userSessions[bob_id] = session_id`
- âœ… `isSessionReady = true`
- âœ… Alice Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑÑ‚ÑŒ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ

**âš ï¸ ĞŸĞ ĞĞ‘Ğ›Ğ•ĞœĞ**: Bob Ñ‚Ğ¾Ğ¶Ğµ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ ÑÑ‚Ğ¾ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğµ! Ğ§Ñ‚Ğ¾ Ğ¾Ğ½ Ğ´ĞµĞ»Ğ°ĞµÑ‚?
- âŒ Ğ•ÑĞ»Ğ¸ Bob Ñ‚Ğ¾Ğ¶Ğµ Ğ²Ñ‹Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ `initializeSession` â†’ ĞšĞĞĞ¤Ğ›Ğ˜ĞšĞ¢!
- âŒ Bob Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€ÑƒĞµÑ‚ÑÑ ĞºĞ°Ğº initiator Ñ Ğ”Ğ Ğ£Ğ“Ğ˜ĞœĞ˜ ĞºĞ»ÑÑ‡Ğ°Ğ¼Ğ¸
- âŒ ĞšĞ»ÑÑ‡Ğ¸ Alice Ğ¸ Bob Ğ½Ğµ ÑĞ¾Ğ²Ğ¿Ğ°Ğ´Ğ°ÑÑ‚ â†’ Ñ€Ğ°ÑÑˆĞ¸Ñ„Ñ€Ğ¾Ğ²ĞºĞ° fails

### Ğ¨Ğ°Ğ³ 3: Alice Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµÑ‚ Ğ¿ĞµÑ€Ğ²Ğ¾Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ User types: "Hello Bob!"                                    â”‚
â”‚  â”‚                                                           â”‚
â”‚  â”œâ”€â†’ ChatViewModel.sendMessage(text: "Hello Bob!")         â”‚
â”‚  â”‚    â”œâ”€â†’ isSessionReady? â†’ YES âœ…                          â”‚
â”‚  â”‚    â”‚                                                      â”‚
â”‚  â”‚    â””â”€â†’ CryptoManager.shared.encryptMessage(             â”‚
â”‚  â”‚         "Hello Bob!",                                     â”‚
â”‚  â”‚         for: bob_id                                       â”‚
â”‚  â”‚       )                                                   â”‚
â”‚  â”‚       â”‚                                                   â”‚
â”‚  â”‚       â”œâ”€â†’ sessionId = userSessions[bob_id]               â”‚
â”‚  â”‚       â”‚                                                   â”‚
â”‚  â”‚       â””â”€â†’ [Swift â†’ Rust] core.encryptMessage(            â”‚
â”‚  â”‚            sessionId: session_id,                         â”‚
â”‚  â”‚            plaintext: "Hello Bob!"                        â”‚
â”‚  â”‚          )                                                â”‚
â”‚  â”‚          â”‚                                                â”‚
â”‚  â”‚          â”œâ”€â†’ [Rust] session.encrypt(plaintext)           â”‚
â”‚  â”‚          â”‚    â”œâ”€â†’ messageNumber = 0 (first message!)    â”‚
â”‚  â”‚          â”‚    â”œâ”€â†’ ephemeralPublicKey = sending_dh_pub   â”‚
â”‚  â”‚          â”‚    â”œâ”€â†’ ChaCha20Poly1305 encrypt               â”‚
â”‚  â”‚          â”‚    â””â”€â†’ Returns: EncryptedRatchetMessage      â”‚
â”‚  â”‚          â”‚                                                â”‚
â”‚  â”‚          â””â”€â†’ Returns to Swift: {                         â”‚
â”‚  â”‚               ephemeralPublicKey: [32 bytes],            â”‚
â”‚  â”‚               messageNumber: 0,                           â”‚
â”‚  â”‚               content: "Base64(nonce || ciphertext)"     â”‚
â”‚  â”‚             }                                             â”‚
â”‚  â”‚                                                           â”‚
â”‚  â””â”€â†’ wsManager.send(.sendMessage({                          â”‚
â”‚       id: UUID(),                                            â”‚
â”‚       from: alice_id,                                        â”‚
â”‚       to: bob_id,                                            â”‚
â”‚       ephemeralPublicKey: [32 bytes],                        â”‚
â”‚       messageNumber: 0,                                      â”‚
â”‚       content: "Base64...",                                  â”‚
â”‚       timestamp: 1234567890                                  â”‚
â”‚     }))                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ĞšÑ€Ğ¸Ğ¿Ñ‚Ğ¾Ğ³Ñ€Ğ°Ñ„Ğ¸Ñ**:
```
Plaintext: "Hello Bob!" (10 bytes)
â†“ ChaCha20-Poly1305 encrypt
â”œâ”€â†’ Nonce: 12 random bytes
â”œâ”€â†’ Ciphertext: 10 bytes
â””â”€â†’ Tag: 16 bytes

Sealed box = Nonce || Ciphertext || Tag (38 bytes total)
â†“ Base64
Content: "MCjEIt/HWOi8cAjhludB..." (52 chars)
```

---

## Ğ”ĞµÑ‚Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ flow: Bob â†’ Alice (Ğ¾Ñ‚Ğ²ĞµÑ‚)

### Ğ¨Ğ°Ğ³ 4: Bob Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ Ğ¿ĞµÑ€Ğ²Ğ¾Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ¾Ñ‚ Alice

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ChatsViewModel receives:                                    â”‚
â”‚ .message({                                                   â”‚
â”‚   id: "msg123",                                              â”‚
â”‚   from: alice_id,                                            â”‚
â”‚   to: bob_id,                                                â”‚
â”‚   ephemeralPublicKey: [32 bytes],                            â”‚
â”‚   messageNumber: 0,                                          â”‚
â”‚   content: "MCjEIt/HWOi8cAjhludB...",                        â”‚
â”‚   timestamp: 1234567890                                      â”‚
â”‚ })                                                           â”‚
â”‚  â”‚                                                           â”‚
â”‚  â”œâ”€â†’ handleIncomingMessage(message)                         â”‚
â”‚  â”‚    â”‚                                                      â”‚
â”‚  â”‚    â”œâ”€â†’ otherUserId = alice_id                            â”‚
â”‚  â”‚    â”‚                                                      â”‚
â”‚  â”‚    â”œâ”€â†’ hasSession = CryptoManager.shared.hasSession(     â”‚
â”‚  â”‚    â”‚     for: alice_id                                    â”‚
â”‚  â”‚    â”‚   )                                                  â”‚
â”‚  â”‚    â”‚   â””â”€â†’ userSessions[alice_id] â†’ nil â†’ false âŒ       â”‚
â”‚  â”‚    â”‚                                                      â”‚
â”‚  â”‚    â”œâ”€â†’ if !hasSession {  // ğŸ”‘ FIRST MESSAGE PATH        â”‚
â”‚  â”‚    â”‚     // Store first message temporarily              â”‚
â”‚  â”‚    â”‚     pendingFirstMessages[alice_id] = message        â”‚
â”‚  â”‚    â”‚                                                      â”‚
â”‚  â”‚    â”‚     // Request Alice's public key bundle            â”‚
â”‚  â”‚    â”‚     wsManager.send(.getPublicKey(alice_id))         â”‚
â”‚  â”‚    â”‚                                                      â”‚
â”‚  â”‚    â”‚     return  // Exit early                           â”‚
â”‚  â”‚    â”‚   }                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Ğ¡Ğ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ Ğ¿Ğ¾ÑĞ»Ğµ Step 4**:
- âœ… ĞŸĞµÑ€Ğ²Ğ¾Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¾ Ğ² `pendingFirstMessages[alice_id]`
- âœ… Ğ—Ğ°Ğ¿Ñ€Ğ¾Ñ PublicKeyBundle Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½
- âŒ Ğ¡ĞµÑÑĞ¸Ñ ĞµÑ‰Ğµ Ğ½Ğµ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ°
- âŒ Ğ¡Ğ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ ĞµÑ‰Ğµ Ğ½Ğµ Ñ€Ğ°ÑÑˆĞ¸Ñ„Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¾

### Ğ¨Ğ°Ğ³ 5: Ğ¡ĞµÑ€Ğ²ĞµÑ€ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ PublicKeyBundle Alice

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ChatsViewModel receives:                                    â”‚
â”‚ .publicKeyBundle({                                           â”‚
â”‚   userId: alice_id,                                          â”‚
â”‚   username: "alice",                                         â”‚
â”‚   identityPublic: "...",                                     â”‚
â”‚   signedPrekeyPublic: "...",                                 â”‚
â”‚   signature: "...",                                          â”‚
â”‚   verifyingKey: "..."                                        â”‚
â”‚ })                                                           â”‚
â”‚  â”‚                                                           â”‚
â”‚  â”œâ”€â†’ handlePublicKeyBundle(data)                            â”‚
â”‚  â”‚    â”‚                                                      â”‚
â”‚  â”‚    â”œâ”€â†’ Check: pendingFirstMessages[alice_id]?           â”‚
â”‚  â”‚    â”‚    â””â”€â†’ Found: first_message âœ…                      â”‚
â”‚  â”‚    â”‚                                                      â”‚
â”‚  â”‚    â””â”€â†’ CryptoManager.shared.initReceivingSession(       â”‚
â”‚  â”‚         for: alice_id,                                    â”‚
â”‚  â”‚         recipientBundle: alice_bundle,                    â”‚
â”‚  â”‚         firstMessage: first_message                       â”‚
â”‚  â”‚       )                                                   â”‚
â”‚  â”‚       â”‚                                                   â”‚
â”‚  â”‚       â”œâ”€â†’ [Swift â†’ Rust] core.initReceivingSession(     â”‚
â”‚  â”‚       â”‚    alice_id,                                      â”‚
â”‚  â”‚       â”‚    alice_bundle_json,                             â”‚
â”‚  â”‚       â”‚    first_message_json                             â”‚
â”‚  â”‚       â”‚  )                                                â”‚
â”‚  â”‚       â”‚  â”‚                                                â”‚
â”‚  â”‚       â”‚  â”œâ”€â†’ [Rust] X3DH handshake                       â”‚
â”‚  â”‚       â”‚  â”‚    â””â”€â†’ root_key derived                       â”‚
â”‚  â”‚       â”‚  â”‚                                                â”‚
â”‚  â”‚       â”‚  â””â”€â†’ DoubleRatchet::new_receiving_session(       â”‚
â”‚  â”‚       â”‚       root_key,                                   â”‚
â”‚  â”‚       â”‚       bob_identity_private,                       â”‚
â”‚  â”‚       â”‚       first_message                               â”‚
â”‚  â”‚       â”‚     )                                             â”‚
â”‚  â”‚       â”‚     â”œâ”€â†’ Use Alice's ephemeral DH key from msg   â”‚
â”‚  â”‚       â”‚     â”œâ”€â†’ DH(bob_priv, alice_ephemeral) â†’ recv_châ”‚
â”‚  â”‚       â”‚     â””â”€â†’ Session ready for receiving!            â”‚
â”‚  â”‚       â”‚                                                   â”‚
â”‚  â”‚       â””â”€â†’ Returns: session_id                            â”‚
â”‚  â”‚                                                           â”‚
â”‚  â”‚       userSessions[alice_id] = session_id                â”‚
â”‚  â”‚                                                           â”‚
â”‚  â”‚    â”œâ”€â†’ NOW decrypt first message:                        â”‚
â”‚  â”‚    â”‚    CryptoManager.shared.decryptMessage(             â”‚
â”‚  â”‚    â”‚      first_message                                   â”‚
â”‚  â”‚    â”‚    )                                                 â”‚
â”‚  â”‚    â”‚    â”‚                                                 â”‚
â”‚  â”‚    â”‚    â””â”€â†’ [Rust] session.decrypt(encrypted)           â”‚
â”‚  â”‚    â”‚         â”œâ”€â†’ messageNumber = 0                       â”‚
â”‚  â”‚    â”‚         â”œâ”€â†’ ChaCha20Poly1305 decrypt                â”‚
â”‚  â”‚    â”‚         â””â”€â†’ Returns: "Hello Bob!" âœ…                â”‚
â”‚  â”‚    â”‚                                                      â”‚
â”‚  â”‚    â”œâ”€â†’ saveMessage(chat, first_message, "Hello Bob!")   â”‚
â”‚  â”‚    â”‚                                                      â”‚
â”‚  â”‚    â””â”€â†’ pendingFirstMessages.removeValue(forKey: alice_id)â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Ğ¡Ğ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ Ğ¿Ğ¾ÑĞ»Ğµ Step 5**:
- âœ… Rust: `sessions[session_id]` ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ñ‚ receiving session
- âœ… Swift: `userSessions[alice_id] = session_id`
- âœ… ĞŸĞµÑ€Ğ²Ğ¾Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ñ€Ğ°ÑÑˆĞ¸Ñ„Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¾: "Hello Bob!"
- âœ… Ğ¡Ğ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¾ Ğ² Core Data
- âœ… Bob Ğ²Ğ¸Ğ´Ğ¸Ñ‚ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ² UI

---

## ĞŸĞ¾ÑĞ»ĞµĞ´ÑƒÑÑ‰Ğ¸Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ

ĞŸĞ¾ÑĞ»Ğµ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ¸ ÑĞµÑÑĞ¸Ğ¸ Ğ¾Ğ±ĞµĞ¸Ğ¼Ğ¸ ÑÑ‚Ğ¾Ñ€Ğ¾Ğ½Ğ°Ğ¼Ğ¸:

```
Alice (messageNumber=0,1,2,...) â”€â”€â”€â”€â–¶ Bob (decrypt)

Bob (messageNumber=0,1,2,...)   â—€â”€â”€â”€â”€ Alice (decrypt)
```

ĞšĞ°Ğ¶Ğ´Ğ°Ñ ÑÑ‚Ğ¾Ñ€Ğ¾Ğ½Ğ° Ğ²ĞµĞ´ĞµÑ‚ ÑĞ²Ğ¾Ğ¹ ÑÑ‡Ñ‘Ñ‚Ñ‡Ğ¸Ğº:
- **Alice sending chain**: 0, 1, 2, ...
- **Bob sending chain**: 0, 1, 2, ...
- Double Ratchet Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ÑĞµÑ‚ DH ĞºĞ»ÑÑ‡Ğ¸

---

## Ğ¢Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ° ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğ¹

| ĞœĞ¾Ğ¼ĞµĞ½Ñ‚ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ¸ | Alice sessionReady | Alice userSessions | Bob sessionReady | Bob userSessions | ĞœĞ¾Ğ¶ĞµÑ‚ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑÑ‚ÑŒ | ĞœĞ¾Ğ¶ĞµÑ‚ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ°Ñ‚ÑŒ |
|----------------|--------------------|--------------------|------------------|------------------|------------------|----------------|
| T0: ĞÑ‚ĞºÑ€Ñ‹Ñ‚Ğ¸Ğµ Ñ‡Ğ°Ñ‚Ğ° | false | {} | - | - | âŒ Alice | - |
| T1: Alice Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ bob_bundle | **true** | {bob: sid1} | - | - | âœ… Alice | - |
| T2: Alice Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµÑ‚ msg#0 | true | {bob: sid1} | - | - | âœ… Alice | - |
| T3: Bob Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ msg#0 | true | {bob: sid1} | false | {} | âœ… Alice | âŒ Bob |
| T4: Bob Ğ·Ğ°Ğ¿Ñ€Ğ°ÑˆĞ¸Ğ²Ğ°ĞµÑ‚ alice_bundle | true | {bob: sid1} | false | {} | âœ… Alice | âŒ Bob |
| T5: Bob Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€ÑƒĞµÑ‚ receiving | true | {bob: sid1} | **true** | {alice: sid2} | âœ… Alice | âœ… Bob |
| T6: Bob Ñ€Ğ°ÑÑˆĞ¸Ñ„Ñ€Ğ¾Ğ²Ñ‹Ğ²Ğ°ĞµÑ‚ msg#0 | true | {bob: sid1} | true | {alice: sid2} | âœ… Both | âœ… Both |

---

## ĞŸĞ¾Ñ‚ĞµĞ½Ñ†Ğ¸Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼Ñ‹

### ğŸ”´ ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ° #1: Bob Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€ÑƒĞµÑ‚ ÑĞµÑÑĞ¸Ñ ĞºĞ°Ğº initiator

**Ğ¡Ğ¸Ğ¼Ğ¿Ñ‚Ğ¾Ğ¼**: AEAD decryption failed
**ĞŸÑ€Ğ¸Ñ‡Ğ¸Ğ½Ğ°**: Bob Ğ²Ñ‹Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ `init_session` Ğ²Ğ¼ĞµÑÑ‚Ğ¾ `init_receiving_session`
**ĞŸĞ¾ÑĞ»ĞµĞ´ÑÑ‚Ğ²Ğ¸Ñ**:
- Bob Ğ³ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµÑ‚ Ğ¡Ğ’ĞĞ˜ DH ĞºĞ»ÑÑ‡Ğ¸
- ĞšĞ»ÑÑ‡Ğ¸ Bob â‰  ĞšĞ»ÑÑ‡Ğ¸ Alice
- Ğ Ğ°ÑÑˆĞ¸Ñ„Ñ€Ğ¾Ğ²ĞºĞ° Ğ½ĞµĞ²Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ°

**Ğ ĞµÑˆĞµĞ½Ğ¸Ğµ**: âœ… Ğ˜ÑĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¾ Ğ² ChatViewModel.swift (lines 184-213)

### ğŸ”´ ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ° #2: Ğ”ÑƒĞ±Ğ»Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸ PublicKeyBundle

**Ğ¡Ğ¸Ğ¼Ğ¿Ñ‚Ğ¾Ğ¼**: Ğ›Ğ¾Ğ³Ğ¸ Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ÑÑ‚ "Received public key bundle" Ğ´Ğ²Ğ°Ğ¶Ğ´Ñ‹
**ĞŸÑ€Ğ¸Ñ‡Ğ¸Ğ½Ğ°**:
- ChatViewModel Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°ĞµÑ‚ .publicKeyBundle
- ChatsViewModel Ğ¢ĞĞ–Ğ• Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°ĞµÑ‚ .publicKeyBundle

**ĞŸĞ¾ÑĞ»ĞµĞ´ÑÑ‚Ğ²Ğ¸Ñ**:
- Ğ”Ğ²Ğµ Ğ¿Ğ¾Ğ¿Ñ‹Ñ‚ĞºĞ¸ Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸ ÑĞµÑÑĞ¸Ğ¸
- Race conditions
- ĞĞµĞ¿Ñ€ĞµĞ´ÑĞºĞ°Ğ·ÑƒĞµĞ¼Ğ¾Ğµ Ğ¿Ğ¾Ğ²ĞµĞ´ĞµĞ½Ğ¸Ğµ

**Ğ ĞµÑˆĞµĞ½Ğ¸Ğµ**:
- ChatViewModel Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°ĞµÑ‚ Ğ¢ĞĞ›Ğ¬ĞšĞ Ğ´Ğ»Ñ Ğ¸ÑÑ…Ğ¾Ğ´ÑÑ‰Ğ¸Ñ… ÑĞµÑÑĞ¸Ğ¹ (initiator)
- ChatsViewModel Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°ĞµÑ‚ Ğ¢ĞĞ›Ğ¬ĞšĞ Ğ´Ğ»Ñ Ğ²Ñ…Ğ¾Ğ´ÑÑ‰Ğ¸Ñ… ÑĞµÑÑĞ¸Ğ¹ (responder Ñ pending message)

### ğŸŸ¡ ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ° #3: ĞŸĞ¾Ñ‚ĞµÑ€Ñ ÑĞµÑÑĞ¸Ğ¹ Ğ¿Ñ€Ğ¸ Ğ¿ĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑĞºĞµ

**Ğ¡Ğ¸Ğ¼Ğ¿Ñ‚Ğ¾Ğ¼**: ĞŸĞ¾ÑĞ»Ğµ Ğ¿ĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑĞºĞ° Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ ÑĞµÑÑĞ¸Ğ¸ Ğ½Ğµ Ğ²Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ÑÑ‚ÑÑ
**ĞŸÑ€Ğ¸Ñ‡Ğ¸Ğ½Ğ°**:
- `userSessions` Ğ² Ğ¿Ğ°Ğ¼ÑÑ‚Ğ¸
- Rust `sessions: HashMap` Ğ² Ğ¿Ğ°Ğ¼ÑÑ‚Ğ¸
- Core Data ĞĞ• Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ session_id

**ĞŸĞ¾ÑĞ»ĞµĞ´ÑÑ‚Ğ²Ğ¸Ñ**:
- ĞšĞ°Ğ¶Ğ´Ñ‹Ğ¹ Ğ¿ĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑĞº = Ğ½Ğ¾Ğ²Ğ°Ñ ÑĞµÑÑĞ¸Ñ
- Ğ˜ÑÑ‚Ğ¾Ñ€Ğ¸Ñ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹ ĞµÑÑ‚ÑŒ, Ğ½Ğ¾ Ñ€Ğ°ÑÑˆĞ¸Ñ„Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ½ĞµĞ»ÑŒĞ·Ñ

**Ğ ĞµÑˆĞµĞ½Ğ¸Ğµ** (TODO):
1. Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ `Chat.sessionId: String?` Ğ² Core Data
2. Ğ¡ĞµÑ€Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ Double Ratchet ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ
3. ĞŸÑ€Ğ¸ Ğ·Ğ°Ğ¿ÑƒÑĞºĞµ Ğ²Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°Ñ‚ÑŒ Ğ¸Ğ· Keychain

### ğŸŸ¡ ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ° #4: ĞĞµÑ‚ ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸ Ğ¼ĞµĞ¶Ğ´Ñƒ ÑĞ»Ğ¾ÑĞ¼Ğ¸

**Ğ¡Ğ¸Ğ¼Ğ¿Ñ‚Ğ¾Ğ¼**: Chat ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒĞµÑ‚ Ğ² Core Data, Ğ½Ğ¾ ÑĞµÑÑĞ¸Ğ¸ Ğ½ĞµÑ‚
**ĞŸÑ€Ğ¸Ñ‡Ğ¸Ğ½Ğ°**: Ğ¢Ñ€Ğ¸ Ğ½ĞµĞ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ñ‹Ñ… Ñ…Ñ€Ğ°Ğ½Ğ¸Ğ»Ğ¸Ñ‰Ğ°:
- Core Data (Chat/Message)
- CryptoManager.userSessions
- Rust sessions HashMap

**Ğ ĞµÑˆĞµĞ½Ğ¸Ğµ** (TODO): Ğ•Ğ´Ğ¸Ğ½Ğ°Ñ state Ğ¼Ğ°ÑˆĞ¸Ğ½Ğ°

---

## Ğ¡Ğ»ĞµĞ´ÑƒÑÑ‰Ğ¸Ğµ ÑˆĞ°Ğ³Ğ¸

1. âœ… Ğ”Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ñ‚ĞµĞºÑƒÑ‰ÑƒÑ ÑÑ…ĞµĞ¼Ñƒ
2. â¸ ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ ChatViewModel: ÑƒĞ±Ñ€Ğ°Ñ‚ÑŒ Ğ´ÑƒĞ±Ğ»Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸ PublicKeyBundle
3. â¸ ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ ChatsViewModel: Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ğ°Ñ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° pending messages
4. â¸ Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ´ĞµÑ‚Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ Ğ»Ğ¾Ğ³Ğ¸ Ğ½Ğ° ĞºĞ°Ğ¶Ğ´Ğ¾Ğ¼ ÑˆĞ°Ğ³Ğµ
5. â¸ ĞŸÑ€Ğ¾Ñ‚ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ ÑÑ†ĞµĞ½Ğ°Ñ€Ğ¸Ğ¹ Alice â†’ Bob â†’ Alice
6. â¸ Ğ ĞµĞ°Ğ»Ğ¸Ğ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ persistence ÑĞµÑÑĞ¸Ğ¹

---

**Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ°**: ğŸ”´ DRAFT - Ñ‚Ñ€ĞµĞ±ÑƒĞµÑ‚ÑÑ Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ñ Ğ¿Ñ€Ğ¾Ñ‚Ğ¸Ğ² Ñ€ĞµĞ°Ğ»ÑŒĞ½Ğ¾Ğ³Ğ¾ ĞºĞ¾Ğ´Ğ°
