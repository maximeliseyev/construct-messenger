# API Data Structures v2.0

This document defines the core data structures used in the Construct Messenger API, serialized with MessagePack.

## 1. `ChatMessage`

The primary structure for transporting encrypted messages, compatible with the Double Ratchet protocol.

```typescript
// types/chat.ts
export interface ChatMessage {
  id: string;                 // UUID v4
  from: string;               // Sender's UUID
  to: string;                 // Recipient's UUID
  ephemeralPublicKey: Uint8Array; // 32 bytes X25519 public key
  messageNumber: number;      // uint32, message number in the chain
  content: string;            // Base64 encoded ChaCha20-Poly1305 sealed box
  timestamp: number;          // Unix timestamp (seconds)
}
```

### Validation
A `ChatMessage` must be validated on the client-side before being sent to the Rust core to ensure data integrity.

```typescript
export function validateChatMessage(msg: ChatMessage): ValidationResult {
  const errors: string[] = [];

  // UUID validation
  if (!isValidUUID(msg.id)) errors.push('Invalid message ID');

  // Ephemeral key validation
  if (!msg.ephemeralPublicKey || msg.ephemeralPublicKey.length !== 32) {
    errors.push('Ephemeral public key must be 32 bytes');
  }

  // Other validations...

  return { valid: errors.length === 0, errors };
}
```

## 2. `RegistrationBundle`

A structure containing the public keys required for a new user to register and establish their cryptographic identity. This is generated by the Rust/WASM module.

```typescript
// types/registration.ts
export interface RegistrationBundle {
  identityPublic: string;     // Base64, 44 chars (32 bytes X25519)
  signedPrekeyPublic: string; // Base64, 44 chars (32 bytes X25519)
  signature: string;          // Base64, 88 chars (64 bytes Ed25519)
  verifyingKey: string;       // Base64, 44 chars (32 bytes Ed25519)
}
```

## 3. `PublicKeyBundleData`

The public keys for a user, fetched from the server to initiate a secure session.

```typescript
export interface PublicKeyBundleData {
  userId: string;
  identityPublic: string;
  signedPrekeyPublic: string;
  signature: string;
  verifyingKey: string;
}
```

## 4. `AckData`

An acknowledgment sent by the server after successfully receiving and routing a message.

```typescript
export interface AckData {
  messageId: string; // The ID of the message being acknowledged
  timestamp: number; // Server timestamp
}
```

## 5. `ErrorData`

A generic error message structure.

```typescript
export interface ErrorData {
  code: number;       // Internal error code
  message: string;    // Human-readable error message
  requestId?: string; // Optional ID of the original request
}
```
