# –°–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è API: –ö—Ä–∏–ø—Ç–æ-–≥–∏–±–∫–æ—Å—Ç—å

**–í–µ—Ä—Å–∏—è:** 2.4
**–î–∞—Ç–∞:** 2025-12-26

## 1. –í–≤–µ–¥–µ–Ω–∏–µ

–¶–µ–ª—å —ç—Ç–æ–≥–æ API ‚Äî –≤–Ω–µ–¥—Ä–µ–Ω–∏–µ **–∫—Ä–∏–ø—Ç–æ-–≥–∏–±–∫–æ—Å—Ç–∏ (crypto-agility)**. –≠—Ç–æ –ø–æ–∑–≤–æ–ª–∏—Ç –∫–ª–∏–µ–Ω—Ç–∞–º –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –∫—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏—Ö –∞–ª–≥–æ—Ä–∏—Ç–º–æ–≤ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –∏ —Å–æ–≥–ª–∞—Å–æ–≤—ã–≤–∞—Ç—å –Ω–∞–∏–±–æ–ª–µ–µ –±–µ–∑–æ–ø–∞—Å–Ω—ã–π –∏–∑ –Ω–∏—Ö. –≠—Ç–æ —è–≤–ª—è–µ—Ç—Å—è –∫–ª—é—á–µ–≤—ã–º —à–∞–≥–æ–º –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –ø–æ—Å—Ç–∫–≤–∞–Ω—Ç–æ–≤—ã—Ö (PQ) –≥–∏–±—Ä–∏–¥–Ω—ã—Ö —Å—Ö–µ–º –≤ –±—É–¥—É—â–µ–º.

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –ü—Ä–µ—Ñ–∏–∫—Å –≤–µ—Ä—Å–∏–∏ `/v3/` –±—ã–ª —É–¥–∞–ª–µ–Ω –∏–∑ –ø—É—Ç–µ–π. –í—Å–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã –¥–æ—Å—Ç—É–ø–Ω—ã –Ω–∞–ø—Ä—è–º—É—é –±–µ–∑ –ø—Ä–µ—Ñ–∏–∫—Å–∞ –≤–µ—Ä—Å–∏–∏.

## 2. –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏

### 2.1. –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –Ω–∞–±–æ—Ä–∞ —à–∏—Ñ—Ä–æ–≤ (`SuiteID`)

`SuiteID` ‚Äî —ç—Ç–æ —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ (`u16`), –∫–æ—Ç–æ—Ä–æ–µ —É–Ω–∏–∫–∞–ª—å–Ω–æ –∏–¥–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä—É–µ—Ç –Ω–∞–±–æ—Ä –∫—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏—Ö –ø—Ä–∏–º–∏—Ç–∏–≤–æ–≤ (KEM, –ø–æ–¥–ø–∏—Å—å, AEAD, —Ö—ç—à).

**–ù–∞—á–∞–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ `SuiteID`:**

| ID  | KEM/DH | Signature | AEAD           | Hash    | –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ                  |
|-----|--------|-----------|----------------|---------|-----------------------------|
| 1   | X25519 | Ed25519   | AES-256-GCM    | SHA-512 | **–ë–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π –Ω–∞–±–æ—Ä** |
| 2   | TBD    | TBD       | TBD            | TBD     | *–ó–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–æ –¥–ª—è PQ-–≥–∏–±—Ä–∏–¥–∞* |

### 2.2. –ü–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–π –ø–∞–∫–µ—Ç –∫–ª—é—á–µ–π (`SignedKeyBundle`)

–≠—Ç–æ —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π –æ–±—ä–µ–∫—Ç –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –¥–æ–≤–µ—Ä–∏—è. –í–º–µ—Å—Ç–æ —Ç–æ–≥–æ —á—Ç–æ–±—ã –¥–æ–≤–µ—Ä—è—Ç—å —Å–µ—Ä–≤–µ—Ä—É –≤ —Ç–æ–º, —á—Ç–æ –æ–Ω –æ—Ç–¥–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –∫–ª—é—á–∏, –∫–ª–∏–µ–Ω—Ç –¥–æ–≤–µ—Ä—è–µ—Ç —Ç–æ–ª—å–∫–æ –ø–∞–∫–µ—Ç—É, –∫–æ—Ç–æ—Ä—ã–π –∫—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏ –ø–æ–¥–ø–∏—Å–∞–Ω –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã–º **–∫–ª—é—á–æ–º –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏** (`masterIdentityKey`) –¥—Ä—É–≥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

- **–ü—Ä–æ—Ü–µ—Å—Å —Å–æ–∑–¥–∞–Ω–∏—è (–Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ):**
  1. –ö–ª–∏–µ–Ω—Ç –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø—É–±–ª–∏—á–Ω—ã–µ –∫–ª—é—á–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –Ω–∞–±–æ—Ä–∞ —à–∏—Ñ—Ä–æ–≤, –∫–æ—Ç–æ—Ä—ã–π –æ–Ω –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç.
  2. –û–Ω —É–ø–∞–∫–æ–≤—ã–≤–∞–µ—Ç –∏—Ö –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä—É `BundleData`.
  3. –≠—Ç–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–∞–Ω–æ–Ω–∏—á–µ—Å–∫–∏ —Å–µ—Ä–∏–∞–ª–∏–∑—É–µ—Ç—Å—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≤ JSON –±–µ–∑ –ø—Ä–æ–±–µ–ª–æ–≤) –∏ –ø–æ–¥–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è `masterIdentityKey`.
- **–ü—Ä–æ—Ü–µ—Å—Å –ø—Ä–æ–≤–µ—Ä–∫–∏ (–Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ):**
  1. –ö–ª–∏–µ–Ω—Ç –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –ø–∞–∫–µ—Ç –∫–ª—é—á–µ–π –¥—Ä—É–≥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
  2. **–ü–µ—Ä–µ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º** –æ–Ω –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–æ–¥–ø–∏—Å—å –ø–∞–∫–µ—Ç–∞ —Å –ø–æ–º–æ—â—å—é `masterIdentityKey`. –ï—Å–ª–∏ –ø–æ–¥–ø–∏—Å—å –Ω–µ–≤–µ—Ä–Ω–∞, –ø–∞–∫–µ—Ç –æ—Ç–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è.

## 3. –°—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö (JSON)

### 3.1. –û–±—ä–µ–∫—Ç —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ (`RegisterData`)

–î–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∫–ª–∏–µ–Ω—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –æ–±—ä–µ–∫—Ç `RegisterData`. –ü–æ–ª–µ `publicKey` —ç—Ç–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞ —Å–æ–¥–µ—Ä–∂–∏—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏—Ö –∫–ª—é—á–∞—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∫–∞–∫ **–Ω–∞—Ç–∏–≤–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É MessagePack**.

**‚ö†Ô∏è BREAKING CHANGE (v2.3):** –ü–æ–ª–µ `publicKey` –±–æ–ª—å—à–µ –ù–ï —è–≤–ª—è–µ—Ç—Å—è Base64-–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–Ω–æ–π JSON-—Å—Ç—Ä–æ–∫–æ–π. –¢–µ–ø–µ—Ä—å —ç—Ç–æ –Ω–∞—Ç–∏–≤–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ `UploadableKeyBundle`, –∫–æ—Ç–æ—Ä–∞—è —Å–µ—Ä–∏–∞–ª–∏–∑—É–µ—Ç—Å—è –≤ MessagePack –≤–º–µ—Å—Ç–µ —Å –æ—Å—Ç–∞–ª—å–Ω—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º.

```json
{
  "username": "String",
  "password": "String",
  "publicKey": {
    "masterIdentityKey": "Base64<Bytes>",
    "bundleData": "Base64<Serialized_BundleData>",
    "signature": "Base64<Bytes>"
  }
}
```

- `username`: –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
- `password`: –ü–∞—Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
- `publicKey`: –ù–∞—Ç–∏–≤–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ `UploadableKeyBundle` (—Å–º. —Ä–∞–∑–¥–µ–ª 3.2).

**–ü—Ä–æ—Ü–µ—Å—Å —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è `publicKey` (–∫–ª–∏–µ–Ω—Ç–æ–º):**

1.  **–°–æ–∑–¥–∞–Ω–∏–µ `BundleData`**: –ö–ª–∏–µ–Ω—Ç –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø—É–±–ª–∏—á–Ω—ã–µ –∫–ª—é—á–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º–æ–≥–æ –Ω–∞–±–æ—Ä–∞ —à–∏—Ñ—Ä–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä, X25519 identity key, signed prekey, one-time prekeys) –∏ —É–ø–∞–∫–æ–≤—ã–≤–∞–µ—Ç –∏—Ö –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä—É `BundleData` (—Å–º. —Ä–∞–∑–¥–µ–ª "3.3. `BundleData`"). –ù–∞ —ç—Ç–æ–º —ç—Ç–∞–ø–µ –ø–æ–ª–µ `userId` –≤ `BundleData` –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º.
2.  **–°–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è `BundleData`**: `BundleData` —Å–µ—Ä–∏–∞–ª–∏–∑—É–µ—Ç—Å—è –≤ –∫–∞–Ω–æ–Ω–∏—á–µ—Å–∫—É—é JSON-—Å—Ç—Ä–æ–∫—É.
3.  **–ü–æ–¥–ø–∏—Å—å `BundleData`**: –ö–ª–∏–µ–Ω—Ç –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω—É—é –º–∞—Å—Ç–µ—Ä-–∏–¥–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä—É—é—â—É—é –∫–ª—é—á–µ–≤—É—é –ø–∞—Ä—É Ed25519. –ü–æ–ª—É—á–µ–Ω–Ω–∞—è –Ω–∞ –ø—Ä–µ–¥—ã–¥—É—â–µ–º —à–∞–≥–µ JSON-—Å—Ç—Ä–æ–∫–∞ `BundleData` –ø–æ–¥–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è **–ø—Ä–∏–≤–∞—Ç–Ω—ã–º** –º–∞—Å—Ç–µ—Ä-–∫–ª—é—á–æ–º Ed25519.
4.  **–°–æ–∑–¥–∞–Ω–∏–µ `UploadableKeyBundle`**: –§–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è –æ–±—ä–µ–∫—Ç `UploadableKeyBundle` (—Å–º. —Ä–∞–∑–¥–µ–ª "3.2. `UploadableKeyBundle`"), –∫–æ—Ç–æ—Ä—ã–π –≤–∫–ª—é—á–∞–µ—Ç –≤ —Å–µ–±—è:
    *   Base64-–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã–π **–ø—É–±–ª–∏—á–Ω—ã–π** –º–∞—Å—Ç–µ—Ä-–∫–ª—é—á Ed25519 (`masterIdentityKey`).
    *   Base64-–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–Ω—É—é JSON-—Å—Ç—Ä–æ–∫—É `BundleData` (`bundleData`).
    *   Base64-–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–Ω—É—é –∫—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫—É—é –ø–æ–¥–ø–∏—Å—å (`signature`).
5.  **–û—Ç–ø—Ä–∞–≤–∫–∞**: –ö–ª–∏–µ–Ω—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É `RegisterData` —Å –Ω–∞—Ç–∏–≤–Ω—ã–º `UploadableKeyBundle` –≤ –ø–æ–ª–µ `publicKey`. MessagePack –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–µ—Ä–∏–∞–ª–∏–∑—É–µ—Ç –≤—Å—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ü–µ–ª–∏–∫–æ–º.

### 3.2. `UploadableKeyBundle`
–°—Ç—Ä—É–∫—Ç—É—Ä–∞, –∫–æ—Ç–æ—Ä—É—é –∫–ª–∏–µ–Ω—Ç –∑–∞–≥—Ä—É–∂–∞–µ—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä.

```json
{
  "masterIdentityKey": "Base64<Bytes>",
  "bundleData": "Base64<Serialized_BundleData>",
  "signature": "Base64<Bytes>"
}
```
- `masterIdentityKey`: –î–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã–π –ø—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á Ed25519, –∫–æ—Ç–æ—Ä—ã–º –≤—Å–µ –ø–æ–¥–ø–∏—Å–∞–Ω–æ.
- `bundleData`: –°–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ `BundleData`, –∑–∞–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤ Base64.
- `signature`: Ed25519 –ø–æ–¥–ø–∏—Å—å –æ—Ç `bundleData`.


### 3.3. `BundleData`
–°—Ç—Ä—É–∫—Ç—É—Ä–∞, –∫–æ—Ç–æ—Ä–∞—è —Å–µ—Ä–∏–∞–ª–∏–∑—É–µ—Ç—Å—è –∏ –ø–æ–¥–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è.

```json
{
  "userId": "String",
  "timestamp": "ISO8601_String",
  "supportedSuites": [
    {
      "suiteId": 1,
      "identityKey": "Base64<Bytes>",
      "signedPrekey": "Base64<Bytes>",
      "oneTimePrekeys": ["Base64<Bytes>", ...]
    }
    // ... –∑–¥–µ—Å—å –º–æ–≥—É—Ç –±—ã—Ç—å –¥—Ä—É–≥–∏–µ –Ω–∞–±–æ—Ä—ã
  ]
}
```
- `oneTimePrekeys`: –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π, –Ω–æ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π —Å–ø–∏—Å–æ–∫ –æ–¥–Ω–æ—Ä–∞–∑–æ–≤—ã—Ö –∫–ª—é—á–µ–π.


### 3.4. `EncryptedMessageV3`
–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ E2E-–∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è.

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –ù–∞–∑–≤–∞–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã `EncryptedMessageV3` —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å –∫–æ–¥–æ–≤–æ–π –±–∞–∑–æ–π.

```json
{
  "recipientId": "String",
  "suiteId": "u16",
  "ciphertext": "Base64<Bytes>"
}
```
- `suiteId`: ID –Ω–∞–±–æ—Ä–∞, –∫–æ—Ç–æ—Ä—ã–π –±—ã–ª –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω –¥–ª—è —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è.
- `ciphertext`: –ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ, —Ñ–æ—Ä–º–∞—Ç –∫–æ—Ç–æ—Ä–æ–≥–æ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–º `suiteId`.

## 4. –≠–Ω–¥–ø–æ–∏–Ω—Ç—ã API

### `POST /keys/upload`
–ó–∞–≥—Ä—É–∂–∞–µ—Ç –∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç –ø–∞–∫–µ—Ç –∫–ª—é—á–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

- **URL:** `POST /keys/upload`
- **–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è:** –¢—Ä–µ–±—É–µ—Ç—Å—è (JWT —Ç–æ–∫–µ–Ω –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ `Authorization: Bearer <token>`).
- **Request Body:** `UploadableKeyBundle` (JSON)
- **–î–µ–π—Å—Ç–≤–∏—è —Å–µ—Ä–≤–µ—Ä–∞:**
  1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é JWT. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å –∫–ª—é—á–∏ —Ç–æ–ª—å–∫–æ –¥–ª—è —Å–∞–º–æ–≥–æ —Å–µ–±—è.
  2. **–ù–µ –ø—Ä–æ–≤–µ—Ä—è—Ç—å `signature`**. –≠—Ç–æ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å –∫–ª–∏–µ–Ω—Ç–æ–≤ (zero-trust –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞).
  3. –ü—Ä–æ–≤–µ—Å—Ç–∏ –±–∞–∑–æ–≤—É—é –≤–∞–ª–∏–¥–∞—Ü–∏—é —Ñ–æ—Ä–º–∞—Ç–æ–≤ (Base64) –∏ "—É–º–Ω—É—é" –≤–∞–ª–∏–¥–∞—Ü–∏—é –¥–ª–∏–Ω –∫–ª—é—á–µ–π –≤ `BundleData` –Ω–∞ –æ—Å–Ω–æ–≤–µ `suiteId`.
  4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ `userId` –≤ `BundleData` —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º.
  5. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å `UploadableKeyBundle` –≤ –ë–î (UPSERT - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∏–ª–∏ —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤—ã—Ö).
  6. –ò–Ω–≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å –∫—ç—à Redis –¥–ª—è –¥–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
- **Response:**
  - `200 OK` - —É—Å–ø–µ—à–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞
  - `400 Bad Request` - –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
  - `401 Unauthorized` - –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∏–ª–∏ –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π —Ç–æ–∫–µ–Ω
  - `500 Internal Server Error` - –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞

**–ü—Ä–∏–º–µ—Ä —É—Å–ø–µ—à–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞:**
```json
{
  "status": "ok"
}
```

### `GET /keys/{userId}`
–ü–æ–ª—É—á–∞–µ—Ç –ø–∞–∫–µ—Ç –∫–ª—é—á–µ–π –¥–ª—è —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

- **URL:** `GET /keys/{userId}`
- **–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è:** –¢—Ä–µ–±—É–µ—Ç—Å—è (JWT —Ç–æ–∫–µ–Ω).
- **Path Parameter:** `{userId}` - UUID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- **–î–µ–π—Å—Ç–≤–∏—è —Å–µ—Ä–≤–µ—Ä–∞:**
  1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é.
  2. –ù–∞–π—Ç–∏ –≤ –ë–î `UploadableKeyBundle` –¥–ª—è —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ `userId`.
  3. –í–µ—Ä–Ω—É—Ç—å –µ–≥–æ –≤ —Ç–µ–ª–µ –æ—Ç–≤–µ—Ç–∞.
- **Response:**
  - `200 OK` —Å —Ç–µ–ª–æ–º `UploadableKeyBundle` (JSON)
  - `401 Unauthorized` - –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∏–ª–∏ –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π —Ç–æ–∫–µ–Ω
  - `404 Not Found` - –ø–∞–∫–µ—Ç –∫–ª—é—á–µ–π –Ω–µ –Ω–∞–π–¥–µ–Ω
  - `500 Internal Server Error` - –æ—à–∏–±–∫–∞ –ë–î

**–ü—Ä–∏–º–µ—Ä —É—Å–ø–µ—à–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞:**
```json
{
  "masterIdentityKey": "Base64String...",
  "bundleData": "Base64String...",
  "signature": "Base64String..."
}
```

### `POST /messages/send`
–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç E2E-–∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ.

- **URL:** `POST /messages/send`
- **–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è:** –¢—Ä–µ–±—É–µ—Ç—Å—è (JWT —Ç–æ–∫–µ–Ω).
- **Request Body:** `EncryptedMessageV3` (JSON)
- **–î–µ–π—Å—Ç–≤–∏—è —Å–µ—Ä–≤–µ—Ä–∞:**
  1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é JWT –∏ –∏–∑–≤–ª–µ—á—å `senderId`.
  2. –ü—Ä–æ–≤–µ—Å—Ç–∏ –±–∞–∑–æ–≤—É—é –≤–∞–ª–∏–¥–∞—Ü–∏—é –ø–æ–ª–µ–π (–Ω–µ–ø—É—Å—Ç–æ–π `recipientId`, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π `suiteId`).
  3. –í–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é –¥–ª–∏–Ω—É `ciphertext` –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç `suiteId`:
     - Suite 1 (CLASSIC_X25519): –º–∏–Ω–∏–º—É–º 48 –±–∞–π—Ç (32 ephemeral + 16 AEAD tag)
  4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–∞–º–æ–º—É —Å–µ–±–µ.
  5. –°–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ JSON.
  6. –ü–æ–º–µ—Å—Ç–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –æ—Ñ—Ñ–ª–∞–π–Ω-–æ—á–µ—Ä–µ–¥—å –ø–æ–ª—É—á–∞—Ç–µ–ª—è –≤ Redis (—Å TTL).
  7. –ó–∞–ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å –æ–ø–µ—Ä–∞—Ü–∏—é —Å —Ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º ID (–µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–∞ –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç—å).
- **Response:**
  - `202 Accepted` - —Å–æ–æ–±—â–µ–Ω–∏–µ –ø—Ä–∏–Ω—è—Ç–æ –≤ –æ—á–µ—Ä–µ–¥—å
  - `400 Bad Request` - –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–ª–∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ —Å–∞–º–æ–º—É —Å–µ–±–µ
  - `401 Unauthorized` - –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∏–ª–∏ –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π —Ç–æ–∫–µ–Ω
  - `500 Internal Server Error` - –æ—à–∏–±–∫–∞ –æ—á–µ—Ä–µ–¥–∏

**–ü—Ä–∏–º–µ—Ä —É—Å–ø–µ—à–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞:**
```json
{
  "status": "accepted"
}
```


## 5. WebSocket API

–ü–æ–º–∏–º–æ HTTP-—ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∫–ª—é—á–∞–º–∏ –∏ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏, —Å–µ—Ä–≤–µ—Ä –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç WebSocket API –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏, —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–µ—Å—Å–∏—è–º–∏, –æ–±–º–µ–Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏ –∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è —É—á–µ—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.

### 5.1. –§–æ—Ä–º–∞—Ç —Å–æ–æ–±—â–µ–Ω–∏–π

–í—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ **MessagePack** —Å internally-tagged enum —Ñ–æ—Ä–º–∞—Ç–µ:

```json
{
  "type": "messageType",
  "payload": { /* –¥–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è */ }
}
```

**–í–∞–∂–Ω–æ:**
- –í—Å–µ –ø–æ–ª—è –∏—Å–ø–æ–ª—å–∑—É—é—Ç **camelCase** –Ω–æ—Ç–∞—Ü–∏—é
- –ë–∏–Ω–∞—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è –≤ **Base64** –∫–æ–¥–∏—Ä–æ–≤–∫–µ (–∫—Ä–æ–º–µ `ephemeralPublicKey` –≤ `ChatMessage`, –∫–æ—Ç–æ—Ä—ã–π –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –∫–∞–∫ MessagePack bin)
- UUID –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è –∫–∞–∫ **—Å—Ç—Ä–æ–∫–∏**
- Timestamps –≤ —Ñ–æ—Ä–º–∞—Ç–µ **Unix timestamp (—Å–µ–∫—É–Ω–¥—ã)** –∏–ª–∏ **ISO8601**

---

## 5.2. –ö–ª–∏–µ–Ω—Ç—Å–∫–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è (Client ‚Üí Server)

### 5.2.1. Register (–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è)

–°–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—ã–π –∞–∫–∫–∞—É–Ω—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

**‚ö†Ô∏è BREAKING CHANGE (v2.3):** –ü–æ–ª–µ `publicKey` —Ç–µ–ø–µ—Ä—å –Ω–∞—Ç–∏–≤–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ `UploadableKeyBundle`, –∞ –Ω–µ Base64-–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ç—Ä–æ–∫–∞.

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞:**
```json
{
  "type": "register",
  "payload": {
    "username": "String",
    "password": "String",
    "publicKey": {
      "masterIdentityKey": "Base64<Bytes>",
      "bundleData": "Base64<Serialized_BundleData>",
      "signature": "Base64<Bytes>"
    }
  }
}
```

**–ü–æ–ª—è:**
- `username` (String) - –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—É–Ω–∏–∫–∞–ª—å–Ω–æ–µ)
- `password` (String) - –ø–∞—Ä–æ–ª—å (—Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è: –º–∏–Ω–∏–º—É–º 10 —Å–∏–º–≤–æ–ª–æ–≤, uppercase, lowercase, digit)
- `publicKey` (UploadableKeyBundle) - –Ω–∞—Ç–∏–≤–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å –∫—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–º–∏ –∫–ª—é—á–∞–º–∏ (—Å–º. —Ä–∞–∑–¥–µ–ª 3.2)

**–û—Ç–≤–µ—Ç—ã:**
- `RegisterSuccess` - —É—Å–ø–µ—à–Ω–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
- `Error` —Å –∫–æ–¥–æ–º `WEAK_PASSWORD`, `REGISTRATION_FAILED`, `INVALID_KEY_BUNDLE`

---

### 5.2.2. Login (–í—Ö–æ–¥)

–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä—É–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ —Å–æ–∑–¥–∞–µ—Ç —Å–µ—Å—Å–∏—é.

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞:**
```json
{
  "type": "login",
  "payload": {
    "username": "String",
    "password": "String"
  }
}
```

**–ü–æ–ª—è:**
- `username` (String) - –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `password` (String) - –ø–∞—Ä–æ–ª—å

**Rate Limiting:**
- –ú–∞–∫—Å–∏–º—É–º 5 –Ω–µ—É–¥–∞—á–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫ –∑–∞ 15 –º–∏–Ω—É—Ç
- –ü–æ—Å–ª–µ 5-–π –Ω–µ—É–¥–∞—á–Ω–æ–π –ø–æ–ø—ã—Ç–∫–∏ - –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –Ω–∞ 15 –º–∏–Ω—É—Ç

**–û—Ç–≤–µ—Ç—ã:**
- `LoginSuccess` - —É—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥
- `Error` —Å –∫–æ–¥–æ–º `INVALID_CREDENTIALS`, `RATE_LIMIT_EXCEEDED`

---

### 5.2.3. Connect (–ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Å —Ç–æ–∫–µ–Ω–æ–º)

–í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Å–µ—Å—Å–∏—é –∏—Å–ø–æ–ª—å–∑—É—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π JWT —Ç–æ–∫–µ–Ω.

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞:**
```json
{
  "type": "connect",
  "payload": {
    "sessionToken": "String"
  }
}
```

**–ü–æ–ª—è:**
- `sessionToken` (String) - JWT —Ç–æ–∫–µ–Ω –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–π —Å–µ—Å—Å–∏–∏

**–û—Ç–≤–µ—Ç—ã:**
- `ConnectSuccess` - —É—Å–ø–µ—à–Ω–æ–µ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
- `SessionExpired` - —Å–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞
- `Error` —Å –∫–æ–¥–æ–º `INVALID_TOKEN`

---

### 5.2.4. SearchUsers (–ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)

–ò—â–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ –∏–º–µ–Ω–∏ (–¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ –∫–æ–Ω—Ç–∞–∫—Ç—ã).

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞:**
```json
{
  "type": "searchUsers",
  "payload": {
    "query": "String"
  }
}
```

**–ü–æ–ª—è:**
- `query` (String) - –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å (–º–∏–Ω–∏–º—É–º 1 —Å–∏–º–≤–æ–ª)

**–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:**
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω

**–û—Ç–≤–µ—Ç—ã:**
- `SearchResults` - —Å–ø–∏—Å–æ–∫ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- `Error` —Å –∫–æ–¥–æ–º `UNAUTHORIZED`

---

### 5.2.5. GetPublicKey (–ü–æ–ª—É—á–µ–Ω–∏–µ –ø—É–±–ª–∏—á–Ω—ã—Ö –∫–ª—é—á–µ–π)

–ó–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –ø—É–±–ª–∏—á–Ω—ã–π key bundle –¥—Ä—É–≥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è E2E —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è.

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞:**
```json
{
  "type": "getPublicKey",
  "payload": {
    "userId": "UUID_String"
  }
}
```

**–ü–æ–ª—è:**
- `userId` (String) - UUID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, —á—å–∏ –∫–ª—é—á–∏ –∑–∞–ø—Ä–∞—à–∏–≤–∞—é—Ç—Å—è

**–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:**
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω

**–û—Ç–≤–µ—Ç—ã:**
- `PublicKeyBundle` - –∫–ª—é—á–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `Error` —Å –∫–æ–¥–æ–º `USER_NOT_FOUND`, `KEY_BUNDLE_NOT_FOUND`

---

### 5.2.6. SendMessage (–û—Ç–ø—Ä–∞–≤–∫–∞ E2E-–∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è)

–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç E2E-–∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥—Ä—É–≥–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é.

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞:**
```json
{
  "type": "sendMessage",
  "payload": {
    "id": "UUID_String",
    "from": "UUID_String",
    "to": "UUID_String",
    "ephemeralPublicKey": [Binary 32 bytes],
    "messageNumber": 0,
    "content": "Base64_String",
    "timestamp": 1234567890
  }
}
```

**–ü–æ–ª—è:**
- `id` (String) - UUID —Å–æ–æ–±—â–µ–Ω–∏—è (**–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –∫–ª–∏–µ–Ω—Ç–æ–º** –¥–ª—è offline-first –∏ idempotency)
- `from` (String) - UUID –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è
- `to` (String) - UUID –ø–æ–ª—É—á–∞—Ç–µ–ª—è
- `ephemeralPublicKey` (Binary) - 32 –±–∞–π—Ç–∞ —ç—Ñ–µ–º–µ—Ä–Ω–æ–≥–æ –ø—É–±–ª–∏—á–Ω–æ–≥–æ –∫–ª—é—á–∞ –¥–ª—è Double Ratchet
- `messageNumber` (u32) - –Ω–æ–º–µ—Ä —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —Ü–µ–ø–æ—á–∫–µ –¥–ª—è out-of-order –æ–±—Ä–∞–±–æ—Ç–∫–∏
- `content` (String) - Base64-–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç (ChaCha20-Poly1305)
- `timestamp` (u64) - Unix timestamp –≤ —Å–µ–∫—É–Ω–¥–∞—Ö

**–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:**
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω
- `from` –¥–æ–ª–∂–µ–Ω —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å ID –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –ù–µ–ª—å–∑—è –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è —Å–∞–º–æ–º—É —Å–µ–±–µ

**Rate Limiting:** 1000 —Å–æ–æ–±—â–µ–Ω–∏–π/—á–∞—Å

**–û—Ç–≤–µ—Ç—ã:**
- `Ack` - –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –¥–æ—Å—Ç–∞–≤–∫–∏
- `Error` —Å –∫–æ–¥–æ–º `RECIPIENT_NOT_FOUND`, `RATE_LIMIT_EXCEEDED`

---

### 5.2.7. RotatePrekey (–†–æ—Ç–∞—Ü–∏—è –∫–ª—é—á–µ–π)

–û–±–Ω–æ–≤–ª—è–µ—Ç key bundle –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–¥–ª—è forward secrecy).

**‚ö†Ô∏è BREAKING CHANGE (v2.3):** –ü–æ–ª–µ `update` —Ç–µ–ø–µ—Ä—å –Ω–∞—Ç–∏–≤–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ `UploadableKeyBundle`, –∞ –Ω–µ Base64-–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ç—Ä–æ–∫–∞.

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞:**
```json
{
  "type": "rotatePrekey",
  "payload": {
    "userId": "UUID_String",
    "update": {
      "masterIdentityKey": "Base64<Bytes>",
      "bundleData": "Base64<Serialized_BundleData>",
      "signature": "Base64<Bytes>"
    }
  }
}
```

**–ü–æ–ª—è:**
- `userId` (String) - UUID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–¥–æ–ª–∂–µ–Ω —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–º)
- `update` (UploadableKeyBundle) - –Ω–∞—Ç–∏–≤–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å –Ω–æ–≤—ã–º key bundle

**–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:**
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω
- `userId` –≤ bundle –¥–æ–ª–∂–µ–Ω —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º

**Rate Limiting:** 10 —Ä–æ—Ç–∞—Ü–∏–π/–¥–µ–Ω—å

**–û—Ç–≤–µ—Ç—ã:**
- `KeyRotationSuccess` - —É—Å–ø–µ—à–Ω–∞—è —Ä–æ—Ç–∞—Ü–∏—è
- `Error` —Å –∫–æ–¥–æ–º `RATE_LIMIT_EXCEEDED`, `INVALID_KEY_BUNDLE`, `FORBIDDEN`

---

### 5.2.8. ChangePassword (–°–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è)

–ü–æ–∑–≤–æ–ª—è–µ—Ç –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –∏–∑–º–µ–Ω–∏—Ç—å —Å–≤–æ–π –ø–∞—Ä–æ–ª—å.

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∑–∞–ø—Ä–æ—Å–∞:**
```json
{
  "type": "changePassword",
  "payload": {
    "sessionToken": "String",
    "oldPassword": "String",
    "newPassword": "String",
    "newPasswordConfirm": "String"
  }
}
```

**–ü–æ–ª—è:**
- `sessionToken` - JWT —Ç–æ–∫–µ–Ω —Ç–µ–∫—É—â–µ–π —Å–µ—Å—Å–∏–∏ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
- `oldPassword` - –¢–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
- `newPassword` - –ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ, –º–∏–Ω–∏–º—É–º 8 —Å–∏–º–≤–æ–ª–æ–≤)
- `newPasswordConfirm` - –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø–∞—Ä–æ–ª—è (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ, –¥–æ–ª–∂–Ω–æ —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å `newPassword`)

**–î–µ–π—Å—Ç–≤–∏—è —Å–µ—Ä–≤–µ—Ä–∞:**
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å JWT —Ç–æ–∫–µ–Ω–∞ –∏ –∏–∑–≤–ª–µ—á—å `userId`
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ë–î
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å —Å—Ç–∞—Ä–æ–≥–æ –ø–∞—Ä–æ–ª—è —á–µ—Ä–µ–∑ bcrypt
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ `newPassword` —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å `newPasswordConfirm`
5. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è –æ—Ç —Å—Ç–∞—Ä–æ–≥–æ
6. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é –¥–ª–∏–Ω—É –Ω–æ–≤–æ–≥–æ –ø–∞—Ä–æ–ª—è (‚â• 8 —Å–∏–º–≤–æ–ª–æ–≤)
7. –û–±–Ω–æ–≤–∏—Ç—å —Ö–µ—à –ø–∞—Ä–æ–ª—è –≤ –ë–î (bcrypt —Å DEFAULT_COST)
8. –ó–∞–ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å —É—Å–ø–µ—à–Ω—É—é —Å–º–µ–Ω—É –ø–∞—Ä–æ–ª—è

**–£—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç:**
```json
{
  "type": "changePasswordSuccess"
}
```

**–ö–æ–¥—ã –æ—à–∏–±–æ–∫:**

| –ö–æ–¥ –æ—à–∏–±–∫–∏ | –û–ø–∏—Å–∞–Ω–∏–µ |
|------------|----------|
| `INVALID_TOKEN` | JWT —Ç–æ–∫–µ–Ω –Ω–µ–≤–∞–ª–∏–¥–µ–Ω –∏–ª–∏ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω |
| `INVALID_USER_ID` | –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π user_id –≤ —Ç–æ–∫–µ–Ω–µ |
| `USER_NOT_FOUND` | –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –ë–î |
| `INVALID_PASSWORD` | –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Å—Ç–∞—Ä—ã–π –ø–∞—Ä–æ–ª—å |
| `PASSWORD_MISMATCH` | –ù–æ–≤—ã–µ –ø–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç |
| `SAME_PASSWORD` | –ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å–æ —Å—Ç–∞—Ä—ã–º |
| `WEAK_PASSWORD` | –ü–∞—Ä–æ–ª—å –∫–æ—Ä–æ—á–µ 8 —Å–∏–º–≤–æ–ª–æ–≤ |
| `SERVER_ERROR` | –û—à–∏–±–∫–∞ –ë–î –∏–ª–∏ —Å–µ—Ä–≤–µ—Ä–∞ |

**–ü—Ä–∏–º–µ—Ä –æ—à–∏–±–∫–∏:**
```json
{
  "type": "error",
  "payload": {
    "code": "INVALID_PASSWORD",
    "message": "Old password is incorrect"
  }
}
```

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞:**
- ‚úÖ –í–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –ø–∞—Ä–æ–ª–µ–π –Ω–∞ –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–π —Å—Ç–æ—Ä–æ–Ω–µ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
- ‚úÖ –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å–∏–ª—ã –ø–∞—Ä–æ–ª—è (–¥–ª–∏–Ω–∞, —Å–∏–º–≤–æ–ª—ã, —Ü–∏—Ñ—Ä—ã)
- ‚úÖ –†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞—Ç—å –ø–∞—Ä–æ–ª–∏ –¥–ª–∏–Ω–æ–π –º–∏–Ω–∏–º—É–º 12 —Å–∏–º–≤–æ–ª–æ–≤
- ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å type="password" –¥–ª—è –ø–æ–ª–µ–π –≤–≤–æ–¥–∞
- ‚úÖ –û—á–∏—â–∞—Ç—å –ø–æ–ª—è –ø–∞—Ä–æ–ª—è –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π —Å–º–µ–Ω—ã
- ‚ö†Ô∏è –ù–ï —Ö—Ä–∞–Ω–∏—Ç—å –ø–∞—Ä–æ–ª–∏ –≤ plaintext –∏–ª–∏ localStorage
- ‚ö†Ô∏è –ù–ï –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å –ø–∞—Ä–æ–ª–∏ —á–µ—Ä–µ–∑ query parameters

**–ü—Ä–∏–º–µ—á–∞–Ω–∏—è:**
- –û–ø–µ—Ä–∞—Ü–∏—è —Ç—Ä–µ–±—É–µ—Ç –≤–∞–ª–∏–¥–Ω—ã–π JWT —Ç–æ–∫–µ–Ω —Ç–µ–∫—É—â–µ–π —Å–µ—Å—Å–∏–∏
- –ü–æ—Å–ª–µ —Å–º–µ–Ω—ã –ø–∞—Ä–æ–ª—è —Ç–µ–∫—É—â–∞—è —Å–µ—Å—Å–∏—è –æ—Å—Ç–∞–µ—Ç—Å—è –∞–∫—Ç–∏–≤–Ω–æ–π
- –î—Ä—É–≥–∏–µ –∞–∫—Ç–∏–≤–Ω—ã–µ —Å–µ—Å—Å–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ù–ï –∞–Ω–Ω—É–ª–∏—Ä—É—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
- –°–µ—Ä–≤–µ—Ä –ª–æ–≥–∏—Ä—É–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏—é —Å —É—á–µ—Ç–æ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç–∏ (`LOG_USER_IDENTIFIERS`)

---

### 5.2.9. Logout (–í—ã—Ö–æ–¥)

–ó–∞–≤–µ—Ä—à–∞–µ—Ç —Ç–µ–∫—É—â—É—é —Å–µ—Å—Å–∏—é –∏ –æ—Ç–∑—ã–≤–∞–µ—Ç JWT —Ç–æ–∫–µ–Ω.

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞:**
```json
{
  "type": "logout",
  "payload": {
    "sessionToken": "String"
  }
}
```

**–ü–æ–ª—è:**
- `sessionToken` (String) - JWT —Ç–æ–∫–µ–Ω —Ç–µ–∫—É—â–µ–π —Å–µ—Å—Å–∏–∏

**–û—Ç–≤–µ—Ç—ã:**
- `LogoutSuccess` - —É—Å–ø–µ—à–Ω—ã–π –≤—ã—Ö–æ–¥

---

## 5.3. –°–µ—Ä–≤–µ—Ä–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è (Server ‚Üí Client)

### 5.3.1. RegisterSuccess

–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ–π —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏. –°–æ–¥–µ—Ä–∂–∏—Ç –¥–∞–Ω–Ω—ã–µ –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ JWT —Ç–æ–∫–µ–Ω.

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞:**
```json
{
  "type": "registerSuccess",
  "payload": {
    "userId": "UUID_String",
    "username": "String",
    "sessionToken": "JWT_String",
    "expires": 1234567890
  }
}
```

**–ü–æ–ª—è:**
- `userId` (String) - UUID —Å–æ–∑–¥–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `username` (String) - –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `sessionToken` (String) - JWT —Ç–æ–∫–µ–Ω –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- `expires` (i64) - Unix timestamp –∫–æ–≥–¥–∞ —Ç–æ–∫–µ–Ω –∏—Å—Ç–µ—á–µ—Ç

**–î–µ–π—Å—Ç–≤–∏—è –∫–ª–∏–µ–Ω—Ç–∞:**
1. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å `sessionToken` –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
2. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å `userId` –¥–ª—è –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
3. –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å—Å—è –Ω–∞ –≥–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

**–ü—Ä–∏–º–µ—Ä:**
```json
{
  "type": "registerSuccess",
  "payload": {
    "userId": "550e8400-e29b-41d4-a716-446655440000",
    "username": "alice",
    "sessionToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiI1NTBlODQwMC1lMjliLTQxZDQtYTcxNi00NDY2NTU0NDAwMDAiLCJqdGkiOiJhYmMxMjMiLCJleHAiOjE3MzU2ODk2MDB9.signature",
    "expires": 1735689600
  }
}
```

---

### 5.3.2. LoginSuccess

–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –≤—Ö–æ–¥–∞.

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞:**
```json
{
  "type": "loginSuccess",
  "payload": {
    "userId": "UUID_String",
    "username": "String",
    "sessionToken": "JWT_String",
    "expires": 1234567890
  }
}
```

**–ü–æ–ª—è:**
- `userId` (String) - UUID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `username` (String) - –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `sessionToken` (String) - JWT —Ç–æ–∫–µ–Ω –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- `expires` (i64) - Unix timestamp –∫–æ–≥–¥–∞ —Ç–æ–∫–µ–Ω –∏—Å—Ç–µ—á–µ—Ç

**–ü—Ä–∏–º–µ—Ä:**
```json
{
  "type": "loginSuccess",
  "payload": {
    "userId": "550e8400-e29b-41d4-a716-446655440000",
    "username": "alice",
    "sessionToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "expires": 1735689600
  }
}
```

---

### 5.3.3. ConnectSuccess

–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º —Ç–æ–∫–µ–Ω–æ–º.

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞:**
```json
{
  "type": "connectSuccess",
  "payload": {
    "userId": "UUID_String",
    "username": "String"
  }
}
```

**–ü–æ–ª—è:**
- `userId` (String) - UUID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `username` (String) - –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –ù–ï —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω–æ–≤—ã–π —Ç–æ–∫–µ–Ω - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π

**–ü—Ä–∏–º–µ—Ä:**
```json
{
  "type": "connectSuccess",
  "payload": {
    "userId": "550e8400-e29b-41d4-a716-446655440000",
    "username": "alice"
  }
}
```

---

### 5.3.4. SessionExpired

–°–æ–æ–±—â–∞–µ—Ç, —á—Ç–æ —Å–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞ –∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–≤—Ç–æ—Ä–Ω—ã–π –≤—Ö–æ–¥.

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞:**
```json
{
  "type": "sessionExpired"
}
```

**–ë–µ–∑ payload** (unit variant)

**–î–µ–π—Å—Ç–≤–∏—è –∫–ª–∏–µ–Ω—Ç–∞:**
1. –û—á–∏—Å—Ç–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π `sessionToken`
2. –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ —ç–∫—Ä–∞–Ω –≤—Ö–æ–¥–∞

**–ü—Ä–∏–º–µ—Ä:**
```json
{
  "type": "sessionExpired"
}
```

---

### 5.3.5. SearchResults

–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞:**
```json
{
  "type": "searchResults",
  "payload": {
    "users": [
      {
        "id": "UUID_String",
        "username": "String"
      }
    ]
  }
}
```

**–ü–æ–ª—è:**
- `users` (Array) - –º–∞—Å—Å–∏–≤ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
  - `id` (String) - UUID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  - `username` (String) - –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

**–ü—Ä–∏–º–µ—Ä:**
```json
{
  "type": "searchResults",
  "payload": {
    "users": [
      {
        "id": "550e8400-e29b-41d4-a716-446655440000",
        "username": "alice"
      },
      {
        "id": "6ba7b810-9dad-11d1-80b4-00c04fd430c8",
        "username": "alice_smith"
      }
    ]
  }
}
```

---

### 5.3.6. PublicKeyBundle

–ü—É–±–ª–∏—á–Ω—ã–π key bundle –∑–∞–ø—Ä–æ—à–µ–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è E2E —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è.

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞:**
```json
{
  "type": "publicKeyBundle",
  "payload": {
    "userId": "UUID_String",
    "username": "String",
    "identityPublic": "Base64_String",
    "signedPrekeyPublic": "Base64_String",
    "signature": "Base64_String",
    "verifyingKey": "Base64_String"
  }
}
```

**–ü–æ–ª—è:**
- `userId` (String) - UUID –≤–ª–∞–¥–µ–ª—å—Ü–∞ –∫–ª—é—á–µ–π
- `username` (String) - –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è (–ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è **—Ç–æ–ª—å–∫–æ** –ø—Ä–∏ –æ–±–º–µ–Ω–µ –∫–ª—é—á–∞–º–∏, **–ù–ï** –≤ —Å–æ–æ–±—â–µ–Ω–∏—è—Ö - Signal-–ø–æ–¥–æ–±–Ω–∞—è –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç—å)
- `identityPublic` (String) - Base64-–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—É–±–ª–∏—á–Ω—ã–π identity key X25519 (32 –±–∞–π—Ç–∞)
- `signedPrekeyPublic` (String) - Base64-–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã–π signed prekey X25519 (32 –±–∞–π—Ç–∞)
- `signature` (String) - Base64-–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–Ω–∞—è Ed25519 –ø–æ–¥–ø–∏—Å—å (64 –±–∞–π—Ç–∞)
- `verifyingKey` (String) - Base64-–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã–π Ed25519 verifying key (32 –±–∞–π—Ç–∞)

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –≠—Ç–æ —É—Å—Ç–∞—Ä–µ–≤—à–∏–π —Ñ–æ—Ä–º–∞—Ç. –ù–æ–≤—ã–µ –∫–ª–∏–µ–Ω—Ç—ã –¥–æ–ª–∂–Ω—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `GET /keys/{userId}` HTTP endpoint –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è `UploadableKeyBundle` —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π crypto-agility.

**Privacy Note:** Username –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –æ–±–º–µ–Ω–µ –∫–ª—é—á–∞–º–∏ (key exchange), –∞ –∑–∞—Ç–µ–º —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ. –í —Å–∞–º–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö username **–ù–ï** –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è - —Ç–æ–ª—å–∫–æ UUID. –≠—Ç–æ –º–∏–Ω–∏–º–∏–∑–∏—Ä—É–µ—Ç –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –∏ –ø–æ–≤—ã—à–∞–µ—Ç –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç—å (–∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ Signal Protocol).

**–ü—Ä–∏–º–µ—Ä:**
```json
{
  "type": "publicKeyBundle",
  "payload": {
    "userId": "550e8400-e29b-41d4-a716-446655440000",
    "username": "alice",
    "identityPublic": "AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA=",
    "signedPrekeyPublic": "BBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBB=",
    "signature": "CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC=",
    "verifyingKey": "DDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDD="
  }
}
```

---

### 5.3.7. Message

–í—Ö–æ–¥—è—â–µ–µ E2E-–∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –¥—Ä—É–≥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞:**
```json
{
  "type": "message",
  "payload": {
    "id": "UUID_String",
    "from": "UUID_String",
    "to": "UUID_String",
    "ephemeralPublicKey": [Binary 32 bytes],
    "messageNumber": 0,
    "content": "Base64_String",
    "timestamp": 1234567890
  }
}
```

**–ü–æ–ª—è:** (–∏–¥–µ–Ω—Ç–∏—á–Ω—ã `SendMessage`)
- `id` (String) - UUID —Å–æ–æ–±—â–µ–Ω–∏—è
- `from` (String) - UUID –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è
- `to` (String) - UUID –ø–æ–ª—É—á–∞—Ç–µ–ª—è (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ç–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å)
- `ephemeralPublicKey` (Binary) - 32 –±–∞–π—Ç–∞ —ç—Ñ–µ–º–µ—Ä–Ω–æ–≥–æ –∫–ª—é—á–∞
- `messageNumber` (u32) - –Ω–æ–º–µ—Ä —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —Ü–µ–ø–æ—á–∫–µ
- `content` (String) - Base64-–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç
- `timestamp` (u64) - Unix timestamp –æ—Ç–ø—Ä–∞–≤–∫–∏

**–î–µ–π—Å—Ç–≤–∏—è –∫–ª–∏–µ–Ω—Ç–∞:**
1. –†–∞—Å—à–∏—Ñ—Ä–æ–≤–∞—Ç—å `content` –∏—Å–ø–æ–ª—å–∑—É—è Double Ratchet
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å `messageNumber` –¥–ª—è out-of-order –æ–±—Ä–∞–±–æ—Ç–∫–∏
3. –û—Ç–æ–±—Ä–∞–∑–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é

**–ü—Ä–∏–º–µ—Ä (–≤ MessagePack `ephemeralPublicKey` - –±–∏–Ω–∞—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ, –∑–¥–µ—Å—å –ø–æ–∫–∞–∑–∞–Ω–æ –∫–∞–∫ –º–∞—Å—Å–∏–≤ –±–∞–π—Ç):**
```json
{
  "type": "message",
  "payload": {
    "id": "7c9e6679-7425-40de-944b-e07fc1f90ae7",
    "from": "550e8400-e29b-41d4-a716-446655440000",
    "to": "6ba7b810-9dad-11d1-80b4-00c04fd430c8",
    "ephemeralPublicKey": "<32 bytes binary>",
    "messageNumber": 42,
    "content": "aGVsbG8gd29ybGQhISE=",
    "timestamp": 1735689600
  }
}
```

---

### 5.3.8. Ack

–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –¥–æ—Å—Ç–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è.

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞:**
```json
{
  "type": "ack",
  "payload": {
    "messageId": "UUID_String",
    "status": "String"
  }
}
```

**–ü–æ–ª—è:**
- `messageId` (String) - UUID —Å–æ–æ–±—â–µ–Ω–∏—è, –¥–ª—è –∫–æ—Ç–æ—Ä–æ–≥–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
- `status` (String) - —Å—Ç–∞—Ç—É—Å –¥–æ—Å—Ç–∞–≤–∫–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä: "delivered", "queued")

**–ü—Ä–∏–º–µ—Ä:**
```json
{
  "type": "ack",
  "payload": {
    "messageId": "7c9e6679-7425-40de-944b-e07fc1f90ae7",
    "status": "delivered"
  }
}
```

---

### 5.3.9. KeyRotationSuccess

–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ–π —Ä–æ—Ç–∞—Ü–∏–∏ –∫–ª—é—á–µ–π.

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞:**
```json
{
  "type": "keyRotationSuccess"
}
```

**–ë–µ–∑ payload** (unit variant)

**–î–µ–π—Å—Ç–≤–∏—è –∫–ª–∏–µ–Ω—Ç–∞:**
1. –û–±–Ω–æ–≤–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ key bundle
2. –ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—à–Ω–æ–π —Ä–æ—Ç–∞—Ü–∏–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

**–ü—Ä–∏–º–µ—Ä:**
```json
{
  "type": "keyRotationSuccess"
}
```

---

### 5.3.10. ChangePasswordSuccess

–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ–π —Å–º–µ–Ω—ã –ø–∞—Ä–æ–ª—è.

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞:**
```json
{
  "type": "changePasswordSuccess"
}
```

**–ë–µ–∑ payload** (unit variant)

**–î–µ–π—Å—Ç–≤–∏—è –∫–ª–∏–µ–Ω—Ç–∞:**
1. –û—á–∏—Å—Ç–∏—Ç—å –ø–æ–ª—è –≤–≤–æ–¥–∞ –ø–∞—Ä–æ–ª–µ–π
2. –ü–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—à–Ω–æ–π —Å–º–µ–Ω–µ –ø–∞—Ä–æ–ª—è
3. –û–±–Ω–æ–≤–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –µ—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è

**–ü—Ä–∏–º–µ—Ä:**
```json
{
  "type": "changePasswordSuccess"
}
```

---

### 5.3.11. LogoutSuccess

–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –≤—ã—Ö–æ–¥–∞.

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞:**
```json
{
  "type": "logoutSuccess"
}
```

**–ë–µ–∑ payload** (unit variant)

**–î–µ–π—Å—Ç–≤–∏—è –∫–ª–∏–µ–Ω—Ç–∞:**
1. –û—á–∏—Å—Ç–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π `sessionToken`
2. –ó–∞–∫—Ä—ã—Ç—å WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
3. –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ —ç–∫—Ä–∞–Ω –≤—Ö–æ–¥–∞

**–ü—Ä–∏–º–µ—Ä:**
```json
{
  "type": "logoutSuccess"
}
```

---

### 5.3.12. Error

–°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∑–∞–ø—Ä–æ—Å–∞.

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞:**
```json
{
  "type": "error",
  "payload": {
    "code": "String",
    "message": "String"
  }
}
```

**–ü–æ–ª—è:**
- `code` (String) - –∫–æ–¥ –æ—à–∏–±–∫–∏ –¥–ª—è –ø—Ä–æ–≥—Ä–∞–º–º–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏
- `message` (String) - —á–µ–ª–æ–≤–µ–∫–æ—á–∏—Ç–∞–µ–º–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –æ—à–∏–±–∫–∏

**–†–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–Ω—ã–µ –∫–æ–¥—ã –æ—à–∏–±–æ–∫:**

| –ö–æ–¥ | –û–ø–∏—Å–∞–Ω–∏–µ |
|-----|----------|
| `INVALID_CREDENTIALS` | –ù–µ–≤–µ—Ä–Ω–æ–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ –ø–∞—Ä–æ–ª—å |
| `INVALID_TOKEN` | JWT —Ç–æ–∫–µ–Ω –Ω–µ–≤–∞–ª–∏–¥–µ–Ω –∏–ª–∏ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω |
| `INVALID_USER_ID` | –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç user ID |
| `USER_NOT_FOUND` | –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω |
| `RECIPIENT_NOT_FOUND` | –ü–æ–ª—É—á–∞—Ç–µ–ª—å —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω |
| `SESSION_EXPIRED` | –°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞ |
| `REGISTRATION_FAILED` | –û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ (username –∑–∞–Ω—è—Ç –∏–ª–∏ –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ) |
| `WEAK_PASSWORD` | –ü–∞—Ä–æ–ª—å –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ |
| `INVALID_PASSWORD` | –ù–µ–≤–µ—Ä–Ω—ã–π —Ç–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å –ø—Ä–∏ —Å–º–µ–Ω–µ |
| `PASSWORD_MISMATCH` | –ù–æ–≤—ã–µ –ø–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç |
| `SAME_PASSWORD` | –ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å–æ —Å—Ç–∞—Ä—ã–º |
| `INVALID_KEY_BUNDLE` | –ù–µ–≤–∞–ª–∏–¥–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç key bundle |
| `RATE_LIMIT_EXCEEDED` | –ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤ |
| `FORBIDDEN` | –û–ø–µ—Ä–∞—Ü–∏—è –∑–∞–ø—Ä–µ—â–µ–Ω–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–æ–ø—ã—Ç–∫–∞ –∏–∑–º–µ–Ω–∏—Ç—å —á—É–∂–∏–µ –∫–ª—é—á–∏) |
| `SERVER_ERROR` | –í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ |
| `INVALID_FORMAT` | –ù–µ–≤–∞–ª–∏–¥–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Å–æ–æ–±—â–µ–Ω–∏—è |

**–ü—Ä–∏–º–µ—Ä—ã:**
```json
{
  "type": "error",
  "payload": {
    "code": "RATE_LIMIT_EXCEEDED",
    "message": "Too many failed login attempts. Try again in 15 minutes."
  }
}
```

```json
{
  "type": "error",
  "payload": {
    "code": "WEAK_PASSWORD",
    "message": "Password must be at least 10 characters long"
  }
}
```

---

## 6. –ö–æ–Ω—Ü–µ–ø—Ü–∏—è "–ü—Ä–æ–ª–æ–≥–∞" (Prologue)

–≠—Ç–æ **–æ–±—è–∑–∞–Ω–Ω–æ—Å—Ç—å –∫–ª–∏–µ–Ω—Ç–∞**, —Å–µ—Ä–≤–µ—Ä –Ω–µ —É—á–∞—Å—Ç–≤—É–µ—Ç –≤ —ç—Ç–æ–º –ø—Ä–æ—Ü–µ—Å—Å–µ.

- **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –ü–µ—Ä–µ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ–º –ø—Ä–æ—Ç–æ–∫–æ–ª–∞ –æ–±–º–µ–Ω–∞ –∫–ª—é—á–∞–º–∏ (X3DH) –∫–ª–∏–µ–Ω—Ç—ã –¥–æ–ª–∂–Ω—ã —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å —Å—Ç—Ä–æ–∫—É –¥–ª—è —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è –¥–æ–º–µ–Ω–æ–≤ (domain separation), –Ω–∞–ø—Ä–∏–º–µ—Ä:
  ```
  construct-key-agreement:sender_id->recipient_id
  ```
- –•—ç—à —ç—Ç–æ–π —Å—Ç—Ä–æ–∫–∏ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω –∫–∞–∫ "–∞—Å—Å–æ—Ü–∏–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ" (AD) –ø—Ä–∏ AEAD-—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–∏ –∏–ª–∏ –≤–∫–ª—é—á–µ–Ω –≤ KDF (Key Derivation Function) –¥–ª—è –≤—ã—Ä–∞–±–æ—Ç–∫–∏ —Å–µ—Å—Å–∏–æ–Ω–Ω–æ–≥–æ –∫–ª—é—á–∞.
- –≠—Ç–æ –∑–∞—â–∏—â–∞–µ—Ç –æ—Ç –∞—Ç–∞–∫ –ø–æ–¥–º–µ–Ω—ã –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ (context confusion attacks).


## 7. Encrypted Client Hello (ECH)

–≠—Ç–æ **–∑–∞–¥–∞—á–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ TLS-—Ç–µ—Ä–º–∏–Ω–∞—Ç–æ—Ä–∞**, –∞ –Ω–µ API.

- **–¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ:** –í–µ–±-—Å–µ—Ä–≤–µ—Ä (nginx, caddy) –∏–ª–∏ TLS-—Ç–µ—Ä–º–∏–Ω–∞—Ç–æ—Ä, –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–π –¥–ª—è —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è, –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å–∫–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä–æ–≤–∞–Ω –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ ECH (Encrypted Client Hello), –∫–∞–∫ —Ç–æ–ª—å–∫–æ —ç—Ç–∞ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—è —Å—Ç–∞–Ω–µ—Ç –æ–±—â–µ–¥–æ—Å—Ç—É–ø–Ω–æ–π –∏ —Å—Ç–∞–±–∏–ª—å–Ω–æ–π –≤ –∏—Å–ø–æ–ª—å–∑—É–µ–º–æ–º –ü–û.
- ECH —Å–∫—Ä—ã–≤–∞–µ—Ç SNI (Server Name Indication) –æ—Ç –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª–µ–π —Å–µ—Ç–∏, –ø–æ–≤—ã—à–∞—è –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π.

---

## 8. –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤–µ—Ä—Å–∏–π

### –í–µ—Ä—Å–∏—è 2.4 (2025-12-26) - –ê–∫—Ç—É–∞–ª–∏–∑–∞—Ü–∏—è

**–ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å:**
- ‚úÖ **Message ID**: –£—Ç–æ—á–Ω–µ–Ω–æ, —á—Ç–æ `id` —Å–æ–æ–±—â–µ–Ω–∏–π –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è **–∫–ª–∏–µ–Ω—Ç–æ–º** (–Ω–µ —Å–µ—Ä–≤–µ—Ä–æ–º) –¥–ª—è offline-first –∏ idempotency
- ‚úÖ **PublicKeyBundle.username**: –î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ `username` –≤ –æ—Ç–≤–µ—Ç `PublicKeyBundle` –¥–ª—è Signal-–ø–æ–¥–æ–±–Ω–æ–π –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç–∏
  - Username –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è **—Ç–æ–ª—å–∫–æ** –ø—Ä–∏ –æ–±–º–µ–Ω–µ –∫–ª—é—á–∞–º–∏ (key exchange)
  - –í —Å–∞–º–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö username **–ù–ï** –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è - —Ç–æ–ª—å–∫–æ UUID
  - –≠—Ç–æ –º–∏–Ω–∏–º–∏–∑–∏—Ä—É–µ—Ç –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –∏ –ø–æ–≤—ã—à–∞–µ—Ç –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç—å
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω—ã –ø—Ä–∏–º–µ—Ä—ã —Å–æ–æ–±—â–µ–Ω–∏–π

**–û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å:** –î–ê. –≠—Ç–æ –Ω–µ breaking change - —Ç–æ–ª—å–∫–æ —É—Ç–æ—á–Ω–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø–æ–≤–µ–¥–µ–Ω–∏—è.

---

### –í–µ—Ä—Å–∏—è 2.3 (2025-12-24) - BREAKING CHANGE

**‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–ó–ú–ï–ù–ï–ù–ò–ï:** –£–¥–∞–ª–µ–Ω–∞ —Ç—Ä–æ–π–Ω–∞—è —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–ª—è –ø–æ–≤—ã—à–µ–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∏ —É–ø—Ä–æ—â–µ–Ω–∏—è API.

**–ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å:**
- ‚úÖ **RegisterData.publicKey**: –ò–∑–º–µ–Ω–µ–Ω —Ç–∏–ø —Å `String` (Base64-–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã–π JSON) –Ω–∞ –Ω–∞—Ç–∏–≤–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É `UploadableKeyBundle`
- ‚úÖ **RotatePrekeyData.update**: –ò–∑–º–µ–Ω–µ–Ω —Ç–∏–ø —Å `String` (Base64-–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã–π JSON) –Ω–∞ –Ω–∞—Ç–∏–≤–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É `UploadableKeyBundle`
- ‚úÖ –£–¥–∞–ª–µ–Ω–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç—å –≤ –¥–≤–æ–π–Ω–æ–º Base64-–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–∏ –∏ JSON-—Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏
- ‚úÖ MessagePack —Ç–µ–ø–µ—Ä—å —Å–µ—Ä–∏–∞–ª–∏–∑—É–µ—Ç –≤—Å—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ü–µ–ª–∏–∫–æ–º –±–µ–∑ –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã—Ö –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–π
- ‚úÖ **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è**: –î–æ–±–∞–≤–ª–µ–Ω—ã –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –ø—Ä–∏–º–µ—Ä—ã –¥–ª—è –í–°–ï–• —Å–µ—Ä–≤–µ—Ä–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π:
  - RegisterSuccess, ConnectSuccess, SessionExpired
  - PublicKeyBundle, Message
  - KeyRotationSuccess, ChangePasswordSuccess, LogoutSuccess

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- üöÄ –£–ª—É—á—à–µ–Ω–Ω–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (–æ–¥–Ω–∞ —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤–º–µ—Å—Ç–æ —Ç—Ä–µ—Ö)
- üéØ –£–º–µ–Ω—å—à–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –Ω–∞ ~33% (—É–¥–∞–ª–µ–Ω–∏–µ Base64 overhead)
- üßπ –ë–æ–ª–µ–µ —á–∏—Å—Ç—ã–π –∏ –∏–Ω—Ç—É–∏—Ç–∏–≤–Ω—ã–π API
- üîí –õ—É—á—à–∞—è —Ç–∏–ø–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

**–ú–∏–≥—Ä–∞—Ü–∏—è –¥–ª—è –∫–ª–∏–µ–Ω—Ç–æ–≤:**

**–°—Ç–∞—Ä—ã–π –∫–æ–¥ (v2.2):**
```rust
// –°–æ–∑–¥–∞—Ç—å UploadableKeyBundle
let bundle = UploadableKeyBundle { ... };

// –°–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞—Ç—å –≤ JSON
let bundle_json = serde_json::to_string(&bundle)?;

// –ó–∞–∫–æ–¥–∏—Ä–æ–≤–∞—Ç—å –≤ Base64
let bundle_base64 = BASE64.encode(bundle_json);

// –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–∞–∫ —Å—Ç—Ä–æ–∫—É
let register_data = RegisterData {
    username: "alice".to_string(),
    password: "password123".to_string(),
    public_key: bundle_base64,  // String
};
```

**–ù–æ–≤—ã–π –∫–æ–¥ (v2.3):**
```rust
// –°–æ–∑–¥–∞—Ç—å UploadableKeyBundle
let bundle = UploadableKeyBundle { ... };

// –û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞–ø—Ä—è–º—É—é
let register_data = RegisterData {
    username: "alice".to_string(),
    password: "password123".to_string(),
    public_key: bundle,  // Native UploadableKeyBundle
};
```

**–ó–∞—Ç—Ä–æ–Ω—É—Ç—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è:**
1. `ClientMessage::Register` - –ø–æ–ª–µ `publicKey`
2. `ClientMessage::RotatePrekey` - –ø–æ–ª–µ `update`

**–û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å:** –ù–ï–¢. –ö–ª–∏–µ–Ω—Ç—ã –¥–æ–ª–∂–Ω—ã –æ–±–Ω–æ–≤–∏—Ç—å—Å—è –¥–æ v2.3 –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Å–µ—Ä–≤–µ—Ä–æ–º.

---

### –í–µ—Ä—Å–∏—è 2.2 (2025-12-24)
- ‚úÖ **–ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –û–ë–ù–û–í–õ–ï–ù–ò–ï:** –ü–æ–ª–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –≤—Å–µ—Ö WebSocket —Å–æ–æ–±—â–µ–Ω–∏–π
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω —Ä–∞–∑–¥–µ–ª 5.2 "–ö–ª–∏–µ–Ω—Ç—Å–∫–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è" —Å –¥–µ—Ç–∞–ª—å–Ω—ã–º –æ–ø–∏—Å–∞–Ω–∏–µ–º:
  - Register, Login, Connect, SearchUsers
  - GetPublicKey, SendMessage, RotatePrekey
  - ChangePassword, Logout
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω —Ä–∞–∑–¥–µ–ª 5.3 "–°–µ—Ä–≤–µ—Ä–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è" —Å –¥–µ—Ç–∞–ª—å–Ω—ã–º –æ–ø–∏—Å–∞–Ω–∏–µ–º:
  - RegisterSuccess, LoginSuccess, ConnectSuccess
  - SessionExpired, SearchResults, PublicKeyBundle
  - Message, Ack, KeyRotationSuccess
  - ChangePasswordSuccess, LogoutSuccess, Error
- ‚úÖ –î–ª—è –ö–ê–ñ–î–û–ì–û —Å–æ–æ–±—â–µ–Ω–∏—è —É–∫–∞–∑–∞–Ω—ã:
  - –ü–æ–ª–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –≤—Å–µ—Ö –ø–æ–ª–µ–π —Å —Ç–∏–ø–∞–º–∏
  - –ü—Ä–∏–º–µ—Ä—ã –≤ JSON —Ñ–æ—Ä–º–∞—Ç–µ
  - –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è
  - Rate limiting –≥–¥–µ –ø—Ä–∏–º–µ–Ω–∏–º–æ
  - –î–µ–π—Å—Ç–≤–∏—è –∫–ª–∏–µ–Ω—Ç–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏
- ‚úÖ –ü–æ–ª–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –∫–æ–¥–æ–≤ –æ—à–∏–±–æ–∫ —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º
- ‚úÖ –ü—Ä–∏–º–µ—Ä—ã –≤—Å–µ—Ö –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π

### –í–µ—Ä—Å–∏—è 2.1 (2025-12-24)
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω —Ä–∞–∑–¥–µ–ª "WebSocket API" (–±–∞–∑–æ–≤—ã–π)
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω –º–µ—Ç–æ–¥ —Å–º–µ–Ω—ã –ø–∞—Ä–æ–ª—è (`ChangePassword`)
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –≤–∞–ª–∏–¥–∞—Ü–∏—è:
  - –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ä–æ–≥–æ –ø–∞—Ä–æ–ª—è
  - –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø–∞—Ä–æ–ª—è
  - –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ –ø–∞—Ä–æ–ª—è (10 —Å–∏–º–≤–æ–ª–æ–≤)
  - –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø–∞—Ä–æ–ª—è
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–æ–≤
- ‚úÖ –ü–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ –∫–æ–¥–æ–≤ –æ—à–∏–±–æ–∫ –¥–ª—è —Å–º–µ–Ω—ã –ø–∞—Ä–æ–ª—è

### –í–µ—Ä—Å–∏—è 2.0 (2025-12-24)
- ‚úÖ –£–¥–∞–ª–µ–Ω –ø—Ä–µ—Ñ–∏–∫—Å `/v3/` –∏–∑ –≤—Å–µ—Ö —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤ —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏ –æ—Ç–≤–µ—Ç–æ–≤
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã –∫–æ–¥—ã —Å—Ç–∞—Ç—É—Å–æ–≤ HTTP –¥–ª—è –≤—Å–µ—Ö —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤
- ‚úÖ –£–ª—É—á—à–µ–Ω–æ –æ–ø–∏—Å–∞–Ω–∏–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏

### –í–µ—Ä—Å–∏—è 1.0 (2025-12-22)
- –ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è —Å –ø—Ä–µ—Ñ–∏–∫—Å–æ–º `/v3/`
- –ë–∞–∑–æ–≤–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è crypto-agility
